name: Build and Release KOTORModSync

on:
  pull_request:
    branches: [main, master]
  release:
    types: [published, prereleased, released, created]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (leave empty to use MainConfig.cs version)"
        required: false
        default: ""
  workflow_run:
    workflows: ["Release Please"]
    types:
      - completed

env:
  DOTNET_VERSION: "8.0.x"
  PROJECT_FILE: "KOTORModSync.GUI/KOTORModSync.csproj"

jobs:
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_build: ${{ steps.check.outputs.should_build }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Extract Version from MainConfig.cs
        id: extract
        shell: pwsh
        run: |
          $mainConfigPath = "KOTORModSync.Core/MainConfig.cs"
          $content = Get-Content $mainConfigPath -Raw

          if ($content -match 'CurrentVersion\s*=>\s*"([^"]+)"') {
            $codeVersion = $matches[1]
            Write-Host "Found version in MainConfig.cs: $codeVersion"
            echo "code_version=$codeVersion" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Could not find version in MainConfig.cs"
            echo "code_version=1.0.0" >> $env:GITHUB_OUTPUT
          }

      - name: Determine Version
        id: version
        shell: bash
        run: |
          CODE_VERSION="${{ steps.extract.outputs.code_version }}"

          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            echo "Using GitHub release tag: $VERSION"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
              echo "Using workflow dispatch version: $VERSION"
            else
              VERSION="v${CODE_VERSION}"
              echo "Using MainConfig.cs version: $VERSION"
            fi
          else
            VERSION="v${CODE_VERSION}"
            echo "Using MainConfig.cs version: $VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"

      - name: Check if Should Build
        id: check
        run: |
          if [ "${{ github.event_name }}" = "release" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-and-test:
    name: Build and Test
    needs: determine-version
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Update Info.plist Version
        shell: pwsh
        run: |
          $version = "${{ needs.determine-version.outputs.version }}"
          # Remove 'v' prefix if present
          $cleanVersion = $version -replace '^v', ''

          Write-Host "üìù Updating Info.plist to version: $cleanVersion"

          $plistPath = "Info.plist"
          $content = Get-Content $plistPath -Raw

          # Update CFBundleShortVersionString (e.g., v0.10)
          $content = $content -replace '(<key>CFBundleShortVersionString</key>\s*<string>)[^<]+(</string>)', "`$1v$cleanVersion`$2"

          # Update CFBundleVersion (e.g., v0.10.5)
          $content = $content -replace '(<key>CFBundleVersion</key>\s*<string>)[^<]+(</string>)', "`$1v$cleanVersion`$2"

          $content | Out-File -FilePath $plistPath -Encoding UTF8 -NoNewline

          Write-Host "‚úÖ Info.plist updated successfully"
          Get-Content $plistPath | Select-String -Pattern "CFBundle"

      - name: Setup MSBuild (Windows/.NET Framework 4.8)
        uses: microsoft/setup-msbuild@v2

      - name: Restore NuGet Packages
        run: msbuild KOTORModSync.sln /t:Restore /p:TargetFramework=net48 /p:Configuration=Release

      - name: Build (Development - No Telemetry Secret)
        if: github.event_name == 'pull_request'
        run: msbuild KOTORModSync.sln /p:Configuration=Release /p:TargetFramework=net48

      - name: Inject Telemetry Secret (Official Builds Only)
        if: github.event_name != 'pull_request'
        env:
          TELEMETRY_SECRET: ${{ secrets.KOTORMODSYNC_SIGNING_SECRET }}
        shell: pwsh
        run: |
          Write-Host "üîê Injecting telemetry signing secret for official build..."

          $secretFile = "KOTORModSync.Core/Services/EmbeddedSecrets.cs"

          # Ensure the directory exists
          $dir = Split-Path -Parent $secretFile
          if (-not (Test-Path $dir)) {
            New-Item -ItemType Directory -Path $dir -Force | Out-Null
          }

          # Generate the EmbeddedSecrets.cs file
          $content = @"
          // Copyright 2021-2025 KOTORModSync
          // Licensed under the Business Source License 1.1 (BSL 1.1).
          // See LICENSE.txt file in the project root for full license information.

          // =============================================================================
          // AUTO-GENERATED FILE - DO NOT COMMIT TO GIT
          // =============================================================================
          // This file is automatically generated during GitHub Actions builds.
          // It contains the telemetry signing secret for authenticating with
          // bolabaden.org telemetry infrastructure.
          //
          // Generated: $((Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss UTC"))
          // Workflow: $env:GITHUB_WORKFLOW
          // Run ID: $env:GITHUB_RUN_ID
          // =============================================================================

          namespace KOTORModSync.Core.Services
          {
              /// <summary>
              /// Contains embedded secrets for official builds.
              /// This class is auto-generated during GitHub Actions builds only.
              /// </summary>
              internal static class EmbeddedSecrets
              {
                  /// <summary>
                  /// Telemetry signing key for HMAC-SHA256 authentication with bolabaden.org
                  /// </summary>
                  internal const string TELEMETRY_SIGNING_KEY = "$env:TELEMETRY_SECRET";
              }
          }
          "@

          $content | Out-File -FilePath $secretFile -Encoding UTF8 -NoNewline
          Write-Host "‚úÖ Telemetry secret injected successfully"
          Write-Host "üìÑ File created: $secretFile"

      - name: Build (Official - With Telemetry Secret)
        if: github.event_name != 'pull_request'
        run: msbuild KOTORModSync.sln /p:Configuration=Release /p:TargetFramework=net48 /p:DefineConstants="OFFICIAL_BUILD"

      - name: Setup .NET 8 SDK (for testing only)
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run Unit Tests
        run: dotnet test -c Release --verbosity normal
        continue-on-error: true

      - name: Upload Build Artifacts (Test)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: test-build-no-telemetry
          path: |
            **/bin/Release/**/*.dll
            **/bin/Release/**/*.exe
          retention-days: 7

  publish-multi-platform:
    name: Publish ${{ matrix.rid }}
    needs: [determine-version, build-and-test]
    if: needs.determine-version.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Windows builds
          - rid: win-x64
            os: windows-latest
            framework: net48
            platform: x64
          - rid: win-arm64
            os: windows-latest
            framework: net48
            platform: x64

          # Linux builds
          - rid: linux-x64
            os: ubuntu-latest
            framework: net8.0
            platform: x64
          - rid: linux-arm64
            os: ubuntu-latest
            framework: net8.0
            platform: x64

          # macOS builds
          - rid: osx-x64
            os: macos-latest
            framework: net8.0
            platform: x64
          - rid: osx-arm64
            os: macos-latest
            framework: net8.0
            platform: x64

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Update Info.plist Version
        shell: pwsh
        run: |
          $version = "${{ needs.determine-version.outputs.version }}"
          # Remove 'v' prefix if present
          $cleanVersion = $version -replace '^v', ''

          Write-Host "üìù Updating Info.plist to version: $cleanVersion"

          $plistPath = "Info.plist"
          $content = Get-Content $plistPath -Raw

          # Update CFBundleShortVersionString (e.g., v0.10)
          $content = $content -replace '(<key>CFBundleShortVersionString</key>\s*<string>)[^<]+(</string>)', "`$1v$cleanVersion`$2"

          # Update CFBundleVersion (e.g., v0.10.5)
          $content = $content -replace '(<key>CFBundleVersion</key>\s*<string>)[^<]+(</string>)', "`$1v$cleanVersion`$2"

          $content | Out-File -FilePath $plistPath -Encoding UTF8 -NoNewline

          Write-Host "‚úÖ Info.plist updated for ${{ matrix.rid }}"

      - name: Setup MSBuild (Windows/.NET Framework 4.8)
        if: runner.os == 'Windows'
        uses: microsoft/setup-msbuild@v2

      - name: Setup .NET 8 SDK (Linux/macOS)
        if: runner.os != 'Windows'
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Inject Telemetry Secret
        env:
          TELEMETRY_SECRET: ${{ secrets.KOTORMODSYNC_SIGNING_SECRET }}
        shell: pwsh
        run: |
          Write-Host "üîê Injecting telemetry signing secret..."

          $secretFile = "KOTORModSync.Core/Services/EmbeddedSecrets.cs"
          $dir = Split-Path -Parent $secretFile
          if (-not (Test-Path $dir)) {
            New-Item -ItemType Directory -Path $dir -Force | Out-Null
          }

          $content = @"
          // Copyright 2021-2025 KOTORModSync
          // Licensed under the Business Source License 1.1 (BSL 1.1).
          // See LICENSE.txt file in the project root for full license information.

          // AUTO-GENERATED FILE - DO NOT COMMIT
          // Generated: $((Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss UTC"))

          namespace KOTORModSync.Core.Services
          {
              internal static class EmbeddedSecrets
              {
                  internal const string TELEMETRY_SIGNING_KEY = "$env:TELEMETRY_SECRET";
              }
          }
          "@

          $content | Out-File -FilePath $secretFile -Encoding UTF8 -NoNewline
          Write-Host "‚úÖ Secret injected for ${{ matrix.rid }}"

      - name: Restore Dependencies (Windows - NuGet)
        if: runner.os == 'Windows'
        run: msbuild KOTORModSync.sln /t:Restore /p:TargetFramework=${{ matrix.framework }} /p:Configuration=Release

      - name: Restore Dependencies (Linux/macOS - dotnet)
        if: runner.os != 'Windows'
        run: dotnet restore --framework ${{ matrix.framework }}

      - name: Publish ${{ matrix.rid }} (Windows - MSBuild)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "üî® Publishing ${{ matrix.rid }} using MSBuild (.NET Framework 4.8)..."
          msbuild ${{ env.PROJECT_FILE }} `
            /t:Publish `
            /p:Configuration=Release `
            /p:TargetFramework=${{ matrix.framework }} `
            /p:RuntimeIdentifier=${{ matrix.rid }} `
            /p:SelfContained=true `
            /p:Platform=${{ matrix.platform }} `
            /p:PublishSingleFile=false `
            /p:PublishReadyToRun=true `
            /p:PublishTrimmed=false `
            /p:DefineConstants="OFFICIAL_BUILD" `
            /p:PublishDir="$PWD/publish/${{ matrix.rid }}/"
          Write-Host "‚úÖ Published ${{ matrix.rid }}"

      - name: Publish ${{ matrix.rid }} (Linux/macOS - dotnet)
        if: runner.os != 'Windows'
        shell: pwsh
        run: |
          Write-Host "üî® Publishing ${{ matrix.rid }} using dotnet CLI (.NET 8)..."
          dotnet publish ${{ env.PROJECT_FILE }} `
            -c Release `
            --framework ${{ matrix.framework }} `
            --runtime ${{ matrix.rid }} `
            --self-contained true `
            -p:Platform=${{ matrix.platform }} `
            -p:PublishSingleFile=false `
            -p:PublishReadyToRun=true `
            -p:PublishTrimmed=false `
            -p:DefineConstants="OFFICIAL_BUILD" `
            -o ./publish/${{ matrix.rid }}
          Write-Host "‚úÖ Published ${{ matrix.rid }}"

      - name: Prepare Release Package
        shell: pwsh
        run: |
          $publishDir = "./publish/${{ matrix.rid }}"
          $version = "${{ needs.determine-version.outputs.version }}"
          $packageDir = "./package/KOTORModSync $version"

          Write-Host "üì¶ Preparing release package for ${{ matrix.rid }} version $version..."

          # Create package directory structure
          New-Item -ItemType Directory -Path "$packageDir" -Force | Out-Null
          New-Item -ItemType Directory -Path "$packageDir/docs" -Force | Out-Null

          # Copy application files
          Copy-Item -Path "$publishDir/*" -Destination "$packageDir/" -Recurse -Force

          # Copy Info.plist for macOS builds
          if ("${{ matrix.rid }}" -like "osx-*") {
            if (Test-Path "Info.plist") {
              Copy-Item "Info.plist" "$packageDir/"
              Write-Host "‚úÖ Copied Info.plist for macOS build"
            }
          }

          # Copy documentation
          if (Test-Path "LICENSE.txt") {
            Copy-Item "LICENSE.txt" "$packageDir/docs/"
          }
          if (Test-Path "KOTORModSync - Official Documentation.txt") {
            Copy-Item "KOTORModSync - Official Documentation.txt" "$packageDir/docs/"
          }
          if (Test-Path "TELEMETRY_SETUP_GUIDE.md") {
            Copy-Item "TELEMETRY_SETUP_GUIDE.md" "$packageDir/docs/"
          }
          if (Test-Path "README.md") {
            Copy-Item "README.md" "$packageDir/docs/"
          }

          Write-Host "‚úÖ Package prepared: $packageDir"

      - name: Create Archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $packageDir = "./package"
          $version = "${{ needs.determine-version.outputs.version }}"
          $archiveName = "KOTORModSync-$version-${{ matrix.rid }}.zip"

          Write-Host "üóúÔ∏è Creating archive: $archiveName"

          Compress-Archive -Path "$packageDir/*" -DestinationPath $archiveName -Force

          Write-Host "‚úÖ Archive created: $archiveName"
          Write-Host "üìä Archive size: $((Get-Item $archiveName).Length / 1MB) MB"

      - name: Create Archive (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          version="${{ needs.determine-version.outputs.version }}"
          archive_name="KOTORModSync-$version-${{ matrix.rid }}.zip"

          echo "üóúÔ∏è Creating archive: $archive_name"

          cd package
          zip -r "../$archive_name" "KOTORModSync $version"
          cd ..

          echo "‚úÖ Archive created: $archive_name"
          echo "üìä Archive size: $(du -h $archive_name | cut -f1)"

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: KOTORModSync-${{ needs.determine-version.outputs.version }}-${{ matrix.rid }}
          path: KOTORModSync-${{ needs.determine-version.outputs.version }}-${{ matrix.rid }}.zip
          retention-days: 90
          compression-level: 0

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: KOTORModSync-${{ needs.determine-version.outputs.version }}-${{ matrix.rid }}.zip
          tag_name: ${{ needs.determine-version.outputs.version }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-appcast:
    name: Generate AppCast
    needs: [determine-version, publish-multi-platform]
    if: needs.determine-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install NetSparkle AppCast Generator
        run: dotnet tool install --global NetSparkleUpdater.Tools.AppCastGenerator

      - name: Download All Release Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: KOTORModSync-${{ needs.determine-version.outputs.version }}-*

      - name: List Downloaded Artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          ls -lah artifacts/

      - name: Generate AppCast Signatures
        env:
          NETSPARKLE_PRIVATE_KEY: ${{ secrets.NETSPARKLE_PRIVATE_KEY }}
        shell: bash
        run: |
          echo "üîê Generating signatures for release files..."

          # Create temp directory for key
          mkdir -p ~/.netsparkle
          echo "$NETSPARKLE_PRIVATE_KEY" > ~/.netsparkle/NetSparkle_Ed25519.priv
          chmod 600 ~/.netsparkle/NetSparkle_Ed25519.priv

          # Create signatures directory
          mkdir -p signatures

          # Generate signature for each platform
          for artifact_dir in artifacts/KOTORModSync-*; do
            if [ -d "$artifact_dir" ]; then
              for zip_file in "$artifact_dir"/*.zip; do
                if [ -f "$zip_file" ]; then
                  filename=$(basename "$zip_file")
                  echo "Signing: $filename"

                  # Generate signature using NetSparkle
                  signature=$(netsparkle-generate-appcast --generate-signature "$zip_file")
                  echo "$signature" > "signatures/${filename}.signature"

                  echo "‚úì Signature generated for $filename"
                fi
              done
            fi
          done

          echo "‚úÖ All signatures generated"

      - name: Update AppCast XML
        shell: bash
        run: |
          version="${{ needs.determine-version.outputs.version }}"
          clean_version="${version#v}"  # Remove 'v' prefix

          echo "üìù Updating appcast.xml for version $version"

          # Backup existing appcast
          cp appcast.xml appcast.xml.bak

          # Get current date in RFC 822 format
          pub_date=$(date -R)

          # Start building new appcast
          cat > appcast.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
              <channel>
                  <title>KOTORModSync Updates</title>
                  <link>https://github.com/th3w1zard1/KOTORModSync</link>
                  <description>Update feed for KOTORModSync</description>
                  <language>en</language>
          EOF

          # Add item for each platform
          for artifact_dir in artifacts/KOTORModSync-*; do
            if [ -d "$artifact_dir" ]; then
              for zip_file in "$artifact_dir"/*.zip; do
                if [ -f "$zip_file" ]; then
                  filename=$(basename "$zip_file")
                  filesize=$(stat -c%s "$zip_file" 2>/dev/null || stat -f%z "$zip_file")

                  # Extract RID from filename (e.g., win-x64 from KOTORModSync-v1.0.0-win-x64.zip)
                  rid=$(echo "$filename" | sed -E 's/.*-([^-]+-[^.]+)\.zip/\1/')

                  # Determine OS from RID
                  case "$rid" in
                    win-*)
                      os="windows"
                      ;;
                    linux-*)
                      os="linux"
                      ;;
                    osx-*)
                      os="macos"
                      ;;
                    *)
                      os="windows"
                      ;;
                  esac

                  # Read signature
                  signature=$(cat "signatures/${filename}.signature")

                  # Add item to appcast
                  cat >> appcast.xml << ITEM

                  <!-- $rid -->
                  <item>
                      <title>Version $clean_version ($rid)</title>
                      <sparkle:releaseNotesLink>https://github.com/th3w1zard1/KOTORModSync/releases/tag/$version</sparkle:releaseNotesLink>
                      <pubDate>$pub_date</pubDate>
                      <enclosure
                          url="https://github.com/th3w1zard1/KOTORModSync/releases/download/$version/$filename"
                          sparkle:version="$clean_version"
                          sparkle:os="$os"
                          length="$filesize"
                          type="application/octet-stream"
                          sparkle:edSignature="$signature" />
                  </item>
          ITEM
                fi
              done
            fi
          done

          # Close XML
          cat >> appcast.xml << 'EOF'
              </channel>
          </rss>
          EOF

          echo "‚úÖ AppCast updated"
          cat appcast.xml

      - name: Commit and Push AppCast
        if: github.event_name == 'release'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add appcast.xml

          if git diff --staged --quiet; then
            echo "No changes to appcast.xml"
          else
            git commit -m "Update appcast.xml for ${{ needs.determine-version.outputs.version }}"
            git push
          fi

      - name: Upload AppCast to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: appcast.xml
          tag_name: ${{ needs.determine-version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore Dependencies
        run: dotnet restore --framework net8.0

      - name: Run Security Audit
        run: dotnet list package --vulnerable --include-transitive
        continue-on-error: true

      - name: Check for Secrets in Code
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

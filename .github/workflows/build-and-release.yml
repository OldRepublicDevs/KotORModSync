name: Build and Release KOTORModSync

on:
  pull_request:
    branches: [main, master]
  release:
    types: [published, prereleased, released, created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (leave empty to use MainConfig.cs version)'
        required: false
        default: ''
  workflow_run:
    workflows: ["Release Please"]
    types:
      - completed

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_FILE: 'KOTORModSync.GUI/KOTORModSync.csproj'

jobs:
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_build: ${{ steps.check.outputs.should_build }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Extract Version from MainConfig.cs
        id: extract
        shell: pwsh
        run: |
          $mainConfigPath = "KOTORModSync.Core/MainConfig.cs"
          $content = Get-Content $mainConfigPath -Raw
          
          if ($content -match 'CurrentVersion\s*=>\s*"([^"]+)"') {
            $codeVersion = $matches[1]
            Write-Host "Found version in MainConfig.cs: $codeVersion"
            echo "code_version=$codeVersion" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Could not find version in MainConfig.cs"
            echo "code_version=1.0.0" >> $env:GITHUB_OUTPUT
          }
      
      - name: Determine Version
        id: version
        shell: bash
        run: |
          CODE_VERSION="${{ steps.extract.outputs.code_version }}"
          
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            echo "Using GitHub release tag: $VERSION"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
              echo "Using workflow dispatch version: $VERSION"
            else
              VERSION="v${CODE_VERSION}"
              echo "Using MainConfig.cs version: $VERSION"
            fi
          else
            VERSION="v${CODE_VERSION}"
            echo "Using MainConfig.cs version: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"
      
      - name: Check if Should Build
        id: check
        run: |
          if [ "${{ github.event_name }}" = "release" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-and-test:
    name: Build and Test
    needs: determine-version
    runs-on: windows-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore NuGet Packages
        run: dotnet restore

      - name: Build (Development - No Telemetry Secret)
        if: github.event_name == 'pull_request'
        run: dotnet build -c Release --no-restore

      - name: Inject Telemetry Secret (Official Builds Only)
        if: github.event_name != 'pull_request'
        env:
          TELEMETRY_SECRET: ${{ secrets.KOTORMODSYNC_SIGNING_SECRET }}
        shell: pwsh
        run: |
          Write-Host "üîê Injecting telemetry signing secret for official build..."
          
          $secretFile = "KOTORModSync.Core/Services/EmbeddedSecrets.cs"
          
          # Ensure the directory exists
          $dir = Split-Path -Parent $secretFile
          if (-not (Test-Path $dir)) {
            New-Item -ItemType Directory -Path $dir -Force | Out-Null
          }
          
          # Generate the EmbeddedSecrets.cs file
          $content = @"
          // Copyright 2021-2025 KOTORModSync
          // Licensed under the Business Source License 1.1 (BSL 1.1).
          // See LICENSE.txt file in the project root for full license information.
          
          // =============================================================================
          // AUTO-GENERATED FILE - DO NOT COMMIT TO GIT
          // =============================================================================
          // This file is automatically generated during GitHub Actions builds.
          // It contains the telemetry signing secret for authenticating with
          // bolabaden.org telemetry infrastructure.
          //
          // Generated: $((Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss UTC"))
          // Workflow: $env:GITHUB_WORKFLOW
          // Run ID: $env:GITHUB_RUN_ID
          // =============================================================================
          
          namespace KOTORModSync.Core.Services
          {
              /// <summary>
              /// Contains embedded secrets for official builds.
              /// This class is auto-generated during GitHub Actions builds only.
              /// </summary>
              internal static class EmbeddedSecrets
              {
                  /// <summary>
                  /// Telemetry signing key for HMAC-SHA256 authentication with bolabaden.org
                  /// </summary>
                  internal const string TELEMETRY_SIGNING_KEY = "$env:TELEMETRY_SECRET";
              }
          }
          "@
          
          $content | Out-File -FilePath $secretFile -Encoding UTF8 -NoNewline
          Write-Host "‚úÖ Telemetry secret injected successfully"
          Write-Host "üìÑ File created: $secretFile"

      - name: Build (Official - With Telemetry Secret)
        if: github.event_name != 'pull_request'
        run: dotnet build -c Release --no-restore /p:DefineConstants="OFFICIAL_BUILD"

      - name: Run Unit Tests
        run: dotnet test -c Release --no-build --verbosity normal

      - name: Upload Build Artifacts (Test)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: test-build-no-telemetry
          path: |
            **/bin/Release/**/*.dll
            **/bin/Release/**/*.exe
          retention-days: 7

  publish-multi-platform:
    name: Publish ${{ matrix.rid }}
    needs: [determine-version, build-and-test]
    if: needs.determine-version.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Windows builds
          - rid: win-x64
            os: windows-latest
            framework: net8.0
            platform: x64
          - rid: win-arm64
            os: windows-latest
            framework: net8.0
            platform: x64
          
          # Linux builds
          - rid: linux-x64
            os: ubuntu-latest
            framework: net8.0
            platform: x64
          - rid: linux-arm64
            os: ubuntu-latest
            framework: net8.0
            platform: x64
          
          # macOS builds
          - rid: osx-x64
            os: macos-latest
            framework: net8.0
            platform: x64
          - rid: osx-arm64
            os: macos-latest
            framework: net8.0
            platform: x64

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Inject Telemetry Secret
        env:
          TELEMETRY_SECRET: ${{ secrets.KOTORMODSYNC_SIGNING_SECRET }}
        shell: pwsh
        run: |
          Write-Host "üîê Injecting telemetry signing secret..."
          
          $secretFile = "KOTORModSync.Core/Services/EmbeddedSecrets.cs"
          $dir = Split-Path -Parent $secretFile
          if (-not (Test-Path $dir)) {
            New-Item -ItemType Directory -Path $dir -Force | Out-Null
          }
          
          $content = @"
          // Copyright 2021-2025 KOTORModSync
          // Licensed under the Business Source License 1.1 (BSL 1.1).
          // See LICENSE.txt file in the project root for full license information.
          
          // AUTO-GENERATED FILE - DO NOT COMMIT
          // Generated: $((Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss UTC"))
          
          namespace KOTORModSync.Core.Services
          {
              internal static class EmbeddedSecrets
              {
                  internal const string TELEMETRY_SIGNING_KEY = "$env:TELEMETRY_SECRET";
              }
          }
          "@
          
          $content | Out-File -FilePath $secretFile -Encoding UTF8 -NoNewline
          Write-Host "‚úÖ Secret injected for ${{ matrix.rid }}"

      - name: Restore Dependencies
        run: dotnet restore

      - name: Publish ${{ matrix.rid }}
        run: |
          dotnet publish ${{ env.PROJECT_FILE }} `
            -c Release `
            --framework ${{ matrix.framework }} `
            --runtime ${{ matrix.rid }} `
            --self-contained true `
            -p:Platform=${{ matrix.platform }} `
            -p:PublishSingleFile=false `
            -p:PublishReadyToRun=true `
            -p:PublishTrimmed=false `
            -p:DefineConstants="OFFICIAL_BUILD" `
            -o ./publish/${{ matrix.rid }}
        shell: pwsh

      - name: Prepare Release Package
        shell: pwsh
        run: |
          $publishDir = "./publish/${{ matrix.rid }}"
          $version = "${{ needs.determine-version.outputs.version }}"
          $packageDir = "./package/KOTORModSync $version"
          
          Write-Host "üì¶ Preparing release package for ${{ matrix.rid }} version $version..."
          
          # Create package directory structure
          New-Item -ItemType Directory -Path "$packageDir" -Force | Out-Null
          New-Item -ItemType Directory -Path "$packageDir/docs" -Force | Out-Null
          
          # Copy application files
          Copy-Item -Path "$publishDir/*" -Destination "$packageDir/" -Recurse -Force
          
          # Copy documentation
          if (Test-Path "LICENSE.txt") {
            Copy-Item "LICENSE.txt" "$packageDir/docs/"
          }
          if (Test-Path "KOTORModSync - Official Documentation.txt") {
            Copy-Item "KOTORModSync - Official Documentation.txt" "$packageDir/docs/"
          }
          if (Test-Path "TELEMETRY_SETUP_GUIDE.md") {
            Copy-Item "TELEMETRY_SETUP_GUIDE.md" "$packageDir/docs/"
          }
          if (Test-Path "README.md") {
            Copy-Item "README.md" "$packageDir/docs/"
          }
          
          Write-Host "‚úÖ Package prepared: $packageDir"

      - name: Create Archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $packageDir = "./package"
          $version = "${{ needs.determine-version.outputs.version }}"
          $archiveName = "KOTORModSync-$version-${{ matrix.rid }}.zip"
          
          Write-Host "üóúÔ∏è Creating archive: $archiveName"
          
          Compress-Archive -Path "$packageDir/*" -DestinationPath $archiveName -Force
          
          Write-Host "‚úÖ Archive created: $archiveName"
          Write-Host "üìä Archive size: $((Get-Item $archiveName).Length / 1MB) MB"

      - name: Create Archive (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          version="${{ needs.determine-version.outputs.version }}"
          archive_name="KOTORModSync-$version-${{ matrix.rid }}.zip"
          
          echo "üóúÔ∏è Creating archive: $archive_name"
          
          cd package
          zip -r "../$archive_name" "KOTORModSync $version"
          cd ..
          
          echo "‚úÖ Archive created: $archive_name"
          echo "üìä Archive size: $(du -h $archive_name | cut -f1)"

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: KOTORModSync-${{ needs.determine-version.outputs.version }}-${{ matrix.rid }}
          path: KOTORModSync-${{ needs.determine-version.outputs.version }}-${{ matrix.rid }}.zip
          retention-days: 90
          compression-level: 0

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: KOTORModSync-${{ needs.determine-version.outputs.version }}-${{ matrix.rid }}.zip
          tag_name: ${{ needs.determine-version.outputs.version }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore Dependencies
        run: dotnet restore

      - name: Run Security Audit
        run: dotnet list package --vulnerable --include-transitive
        continue-on-error: true

      - name: Check for Secrets in Code
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true


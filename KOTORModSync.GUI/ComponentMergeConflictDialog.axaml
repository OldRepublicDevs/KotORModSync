<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:KOTORModSync.Controls"
        x:Class="KOTORModSync.ComponentMergeConflictDialog"
        Width="1400" Height="800"
        Title="Component Merge Conflicts - Power User Mode"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        ExtendClientAreaTitleBarHeightHint="-1"
        SystemDecorations="BorderOnly"
        WindowStartupLocation="CenterOwner">

    <Grid RowDefinitions="Auto,Auto,*,Auto,Auto">
        <!-- Custom Window Controls -->
        <StackPanel Grid.Row="0" HorizontalAlignment="Right" VerticalAlignment="Top"
                    Orientation="Horizontal" Spacing="0" Margin="0,8,8,0">
            <Button Content="-" Click="MinimizeButton_Click"
                    HorizontalContentAlignment="Center" VerticalAlignment="Stretch"
                    HorizontalAlignment="Stretch" Width="40" Height="40" FontSize="15" />
            <Button Content="â–¡" Click="MaximizeButton_Click"
                    HorizontalContentAlignment="Center" VerticalAlignment="Stretch"
                    HorizontalAlignment="Stretch" Width="40" Height="40" FontSize="15" />
            <Button Content="X" Click="CloseButton_Click"
                    HorizontalContentAlignment="Center" VerticalAlignment="Stretch"
                    HorizontalAlignment="Stretch" Width="40" Height="40" FontSize="15" />
        </StackPanel>

        <!-- Header with Stats -->
        <StackPanel Grid.Row="0" Margin="20,20,20,10">
            <TextBlock Text="Component Merge Resolution"
                       FontSize="20" FontWeight="Bold" Margin="0,0,0,8"/>
            <TextBlock Text="{Binding ConflictDescription}"
                       TextWrapping="Wrap" Margin="0,0,0,8"/>
            <TextBlock Text="{Binding MergeImpactSummary}"
                       FontWeight="SemiBold" Foreground="Orange"
                       Margin="0,0,0,8"/>
        </StackPanel>

        <!-- Quick Actions & Options Bar -->
        <Border Grid.Row="1" Margin="20,0" Padding="10"
                Background="{DynamicResource ThemeBackgroundBrush}"
                BorderThickness="1" BorderBrush="{DynamicResource ThemeBorderMidBrush}">
            <Grid RowDefinitions="Auto,Auto,Auto">
                <!-- Search Box -->
                <Grid Grid.Row="0" ColumnDefinitions="*" Margin="0,0,0,10">
                    <controls:SearchBox SearchText="{Binding SearchText, Mode=TwoWay}"
                                       Watermark="ðŸ” Search components by name or author..."/>
                </Grid>

                <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="10">
                    <TextBlock Text="ðŸš€ Quick Actions:" VerticalAlignment="Center" FontWeight="SemiBold"/>
                    <Button Content="Prefer All Incoming"
                            Command="{Binding SelectAllIncomingMatchesCommand}"
                            ToolTip.Tip="For conflicts, choose incoming versions"/>
                    <Button Content="Prefer All Existing"
                            Command="{Binding SelectAllExistingMatchesCommand}"
                            ToolTip.Tip="For conflicts, keep existing versions"/>
                    <Button Content="Keep All New"
                            Command="{Binding KeepAllNewCommand}"
                            ToolTip.Tip="Select all new components from incoming"/>
                    <Button Content="Keep All Unmatched"
                            Command="{Binding KeepAllExistingUnmatchedCommand}"
                            ToolTip.Tip="Keep existing components not in incoming list"/>
                    <Separator Width="2" Background="{DynamicResource ThemeBorderMidBrush}"/>
                    <TextBlock Text="ðŸ’¡ Tip: Click one from each list then:" VerticalAlignment="Center" FontSize="11" Opacity="0.7" Margin="5,0"/>
                    <Button Content="{Binding LinkButtonText}"
                            Command="{Binding LinkSelectedCommand}"
                            IsEnabled="{Binding CanLinkItems}"
                            MinWidth="200"
                            ToolTip.Tip="Manually link the selected existing and incoming components as the same mod (or right-click)"
                            Foreground="LightGreen"/>
                    <Button Content="âŒ Unlink Selected"
                            Command="{Binding UnlinkSelectedCommand}"
                            ToolTip.Tip="Unlink manually or automatically linked components"
                            Foreground="Orange"/>
                </StackPanel>

                <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="15" Margin="0,8,0,0">
                    <CheckBox Content="âš¡ Use incoming list order (Priority)"
                              IsChecked="{Binding UseIncomingOrder, Mode=TwoWay}"
                              FontWeight="SemiBold"
                              ToolTip.Tip="Check: Incoming order is preserved. Uncheck: Existing order is preserved"/>
                    <CheckBox Content="Skip duplicates when both selected"
                              IsChecked="{Binding SkipDuplicates, Mode=TwoWay}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <Grid Grid.Row="2" ColumnDefinitions="*,*,350" Margin="20,10,20,0">
            <!-- Existing Components Column -->
            <Border Grid.Column="0" BorderThickness="1" BorderBrush="{DynamicResource ThemeBorderMidBrush}"
                    Margin="0,0,5,0">
                <Grid RowDefinitions="Auto,*">
                    <Border Grid.Row="0" Background="{DynamicResource ThemeBackgroundBrush}"
                            Padding="10">
                        <StackPanel>
                            <CheckBox Content="ðŸ“‚ EXISTING Components"
                                      IsChecked="{Binding SelectAllExisting, Mode=TwoWay}"
                                      FontWeight="SemiBold" FontSize="13"/>
                            <TextBlock Text="{Binding ExistingSourceInfo}"
                                       FontSize="11" Opacity="0.7" Margin="25,2,0,0"/>
                        </StackPanel>
                    </Border>

                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding FilteredExistingComponents}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderThickness="3"
                                            BorderBrush="{Binding SelectionBorderBrush}"
                                            Padding="10"
                                            Background="{Binding SelectionBackground}"
                                            PointerPressed="OnItemClicked"
                                            ContextRequested="OnItemContextRequested"
                                            Cursor="Hand">
                                        <Border.Styles>
                                            <Style Selector="Border:pointerover">
                                                <Setter Property="Opacity" Value="0.8"/>
                                            </Style>
                                        </Border.Styles>
                                        <Border.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="ðŸ”— Link with selected incoming component"
                                                          Click="LinkSelectedMenuItem_Click"
                                                          IsEnabled="{Binding $parent[Window].DataContext.CanLinkItems}"/>
                                                <MenuItem Header="âŒ Unlink this component" Click="UnlinkMenuItem_Click"/>
                                            </ContextMenu>
                                        </Border.ContextMenu>
                                        <Grid ColumnDefinitions="Auto,Auto,60,*" RowDefinitions="Auto,Auto,Auto">
                                            <CheckBox Grid.Column="0" Grid.Row="0" Grid.RowSpan="3"
                                                      IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                      VerticalAlignment="Center" Margin="0,0,10,0"/>

                                            <!-- Status Icon -->
                                            <TextBlock Grid.Column="1" Grid.Row="0" Grid.RowSpan="3"
                                                       Text="{Binding StatusIcon}"
                                                       FontSize="24"
                                                       Foreground="{Binding StatusColor}"
                                                       VerticalAlignment="Center" Margin="0,0,10,0"
                                                       ToolTip.Tip="{Binding Status}"/>

                                            <Image Grid.Column="2" Grid.Row="0" Grid.RowSpan="3"
                                                   Width="50" Height="50" Margin="0,0,10,0">
                                                <Image.Source>
                                                    <DrawingImage>
                                                        <DrawingImage.Drawing>
                                                            <GeometryDrawing Brush="{DynamicResource ThemeForegroundBrush}">
                                                                <GeometryDrawing.Geometry>
                                                                    <PathGeometry Figures="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                                                </GeometryDrawing.Geometry>
                                                            </GeometryDrawing>
                                                        </DrawingImage.Drawing>
                                                    </DrawingImage>
                                                </Image.Source>
                                            </Image>

                                            <TextBlock Grid.Column="3" Grid.Row="0"
                                                       Text="{Binding Name}"
                                                       FontWeight="SemiBold"
                                                       TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Grid.Column="3" Grid.Row="1"
                                                       Text="{Binding Author}"
                                                       FontSize="11" Opacity="0.7"/>
                                            <TextBlock Grid.Column="3" Grid.Row="2"
                                                       Text="{Binding SizeInfo}"
                                                       FontSize="11" Opacity="0.7"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Incoming Components Column -->
            <Border Grid.Column="1" BorderThickness="1" BorderBrush="{DynamicResource ThemeBorderMidBrush}"
                    Margin="5,0,5,0">
                <Grid RowDefinitions="Auto,*">
                    <Border Grid.Row="0" Background="{DynamicResource ThemeBackgroundBrush}"
                            Padding="10">
                        <StackPanel>
                            <CheckBox Content="ðŸ“¥ INCOMING Components"
                                      IsChecked="{Binding SelectAllIncoming, Mode=TwoWay}"
                                      FontWeight="SemiBold" FontSize="13"/>
                            <TextBlock Text="{Binding IncomingSourceInfo}"
                                       FontSize="11" Opacity="0.7" Margin="25,2,0,0"/>
                        </StackPanel>
                    </Border>

                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding FilteredIncomingComponents}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderThickness="3"
                                            BorderBrush="{Binding SelectionBorderBrush}"
                                            Padding="10"
                                            Background="{Binding SelectionBackground}"
                                            PointerPressed="OnItemClicked"
                                            ContextRequested="OnItemContextRequested"
                                            Cursor="Hand">
                                        <Border.Styles>
                                            <Style Selector="Border:pointerover">
                                                <Setter Property="Opacity" Value="0.8"/>
                                            </Style>
                                        </Border.Styles>
                                        <Border.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="ðŸ”— Link with selected existing component"
                                                          Click="LinkSelectedMenuItem_Click"
                                                          IsEnabled="{Binding $parent[Window].DataContext.CanLinkItems}"/>
                                                <MenuItem Header="âŒ Unlink this component" Click="UnlinkMenuItem_Click"/>
                                            </ContextMenu>
                                        </Border.ContextMenu>
                                        <Grid ColumnDefinitions="Auto,Auto,60,*" RowDefinitions="Auto,Auto,Auto">
                                            <CheckBox Grid.Column="0" Grid.Row="0" Grid.RowSpan="3"
                                                      IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                      VerticalAlignment="Center" Margin="0,0,10,0"/>

                                            <!-- Status Icon -->
                                            <TextBlock Grid.Column="1" Grid.Row="0" Grid.RowSpan="3"
                                                       Text="{Binding StatusIcon}"
                                                       FontSize="24"
                                                       Foreground="{Binding StatusColor}"
                                                       VerticalAlignment="Center" Margin="0,0,10,0"
                                                       ToolTip.Tip="{Binding Status}"/>

                                            <Image Grid.Column="2" Grid.Row="0" Grid.RowSpan="3"
                                                   Width="50" Height="50" Margin="0,0,10,0">
                                                <Image.Source>
                                                    <DrawingImage>
                                                        <DrawingImage.Drawing>
                                                            <GeometryDrawing Brush="{DynamicResource ThemeForegroundBrush}">
                                                                <GeometryDrawing.Geometry>
                                                                    <PathGeometry Figures="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                                                </GeometryDrawing.Geometry>
                                                            </GeometryDrawing>
                                                        </DrawingImage.Drawing>
                                                    </DrawingImage>
                                                </Image.Source>
                                            </Image>

                                            <TextBlock Grid.Column="3" Grid.Row="0"
                                                       Text="{Binding Name}"
                                                       FontWeight="SemiBold"
                                                       TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Grid.Column="3" Grid.Row="1"
                                                       Text="{Binding Author}"
                                                       FontSize="11" Opacity="0.7"/>
                                            <TextBlock Grid.Column="3" Grid.Row="2"
                                                       Text="{Binding SizeInfo}"
                                                       FontSize="11" Opacity="0.7"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Preview & Details Panel -->
            <Grid Grid.Column="2" RowDefinitions="*,Auto">
                <!-- Preview Panel -->
                <Border Grid.Row="0" BorderThickness="1" BorderBrush="{DynamicResource ThemeBorderMidBrush}"
                        Margin="5,0,0,0">
                    <Grid RowDefinitions="Auto,*">
                        <TextBlock Grid.Row="0" Text="ðŸŽ¯ Final Merge Preview"
                                   FontWeight="SemiBold" Padding="10"
                                   Background="{DynamicResource ThemeBackgroundBrush}"/>

                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding PreviewComponents}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderThickness="0,0,0,1"
                                                BorderBrush="{DynamicResource ThemeBorderLowBrush}"
                                                Padding="8,6"
                                                Background="Transparent"
                                                Cursor="Hand">
                                            <Border.Styles>
                                                <Style Selector="Border:pointerover">
                                                    <Setter Property="Background" Value="{DynamicResource ThemeControlHighlightLowBrush}"/>
                                                </Style>
                                            </Border.Styles>
                                            <Grid ColumnDefinitions="Auto,Auto,*,Auto">
                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding OrderNumber}"
                                                           FontSize="11" FontWeight="Bold"
                                                           VerticalAlignment="Center"
                                                           Margin="0,0,8,0" Opacity="0.5"/>
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding StatusIcon}"
                                                           FontSize="14"
                                                           VerticalAlignment="Center"
                                                           Margin="0,0,6,0"/>
                                                <StackPanel Grid.Column="2">
                                                    <TextBlock Text="{Binding Name}"
                                                               FontSize="12" FontWeight="SemiBold"
                                                               TextTrimming="CharacterEllipsis"/>
                                                    <TextBlock Text="{Binding Source}"
                                                               FontSize="10" Opacity="0.6"
                                                               Foreground="{Binding SourceColor}"/>
                                                </StackPanel>
                                                <!-- Position change indicator -->
                                                <TextBlock Grid.Column="3"
                                                           Text="{Binding PositionChange}"
                                                           FontSize="10" FontWeight="Bold"
                                                           Foreground="{Binding PositionChangeColor}"
                                                           VerticalAlignment="Center"
                                                           Margin="4,0,0,0"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Border>

                <!-- Component Details Comparison -->
                <Border Grid.Row="1" BorderThickness="1" BorderBrush="{DynamicResource ThemeBorderMidBrush}"
                        Margin="5,5,0,0" Height="120"
                        IsVisible="{Binding ComparisonVisible}">
                    <Grid RowDefinitions="Auto,*">
                        <TextBlock Grid.Row="0" Text="ðŸ“‹ Component Details"
                                   FontWeight="SemiBold" Padding="6"
                                   FontSize="11"
                                   Background="{DynamicResource ThemeBackgroundBrush}"/>
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                            <TextBlock Text="{Binding ComparisonText}"
                                       FontFamily="Consolas" FontSize="10"
                                       Padding="6" TextWrapping="Wrap"/>
                        </ScrollViewer>
                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <!-- Summary Bar -->
        <Border Grid.Row="3" Margin="20,10" Padding="10"
                Background="{DynamicResource ThemeBackgroundBrush}"
                BorderThickness="1" BorderBrush="{DynamicResource ThemeBorderMidBrush}">
            <TextBlock Text="{Binding ConflictSummary}"
                       FontSize="12" FontWeight="SemiBold"/>
        </Border>

        <!-- Action Buttons -->
        <StackPanel Grid.Row="4" Orientation="Horizontal"
                    HorizontalAlignment="Right" Margin="20,0,20,20">
            <Button Content="âœ“ Continue with Merge"
                    Click="Continue_Click"
                    Width="150" Margin="0,0,10,0"
                    IsDefault="True"/>
            <Button Content="âœ— Cancel"
                    Click="Cancel_Click"
                    Width="100"/>
        </StackPanel>
    </Grid>
</Window>

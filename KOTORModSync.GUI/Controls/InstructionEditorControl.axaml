<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:KOTORModSync.Converters"
             xmlns:controls="clr-namespace:KOTORModSync.Controls"
             x:Class="KOTORModSync.Controls.InstructionEditorControl">
    <UserControl.Resources>
        <converters:IndexConverter x:Key="IndexConverter" />
        <converters:ActionConverter x:Key="ActionConverter" />
        <converters:ListToStringConverter x:Key="ListToStringConverter" />
        <converters:ChooseActionVisibility x:Key="ChooseActionVisibility" />
        <converters:NotChooseActionVisibility x:Key="NotChooseActionVisibility" />
        <converters:PatcherActionVisibility x:Key="PatcherActionVisibility" />
        <converters:NotPatcherActionVisibility x:Key="NotPatcherActionVisibility" />
        <converters:GuidListConverter x:Key="GuidListConverter" />
        <converters:NamespacesIniOptionConverter x:Key="NamespacesIniOptionConverter" />
        <converters:PathStatusConverter x:Key="PathStatusConverter" />
        <converters:PathResolverConverter x:Key="PathResolverConverter" />
    </UserControl.Resources>

    <Border Classes="summary-instruction-card" Margin="0,8,0,0">
        <StackPanel Spacing="12">
            <!-- Header with instruction number and action controls -->
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Border Grid.Column="0" Classes="mod-list-item-badge"
                        CornerRadius="4" Padding="8,4" Margin="0,0,12,0">
                    <TextBlock FontWeight="Bold" FontSize="12" VerticalAlignment="Center">
                        <TextBlock.Text>
                            <MultiBinding Converter="{StaticResource IndexConverter}">
                                <MultiBinding.Bindings>
                                    <Binding Path="$parent[ItemsRepeater].DataContext.Instructions" />
                                    <Binding Path="." />
                                </MultiBinding.Bindings>
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </Border>

                <TextBlock Grid.Column="1" Text="Instruction" Classes="summary-option-title"
                           VerticalAlignment="Center" />

                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                    <controls:ActionButtonsControl
                        DeleteItem="DeleteInstruction_Click"
                        MoveItemUp="MoveInstructionUp_Click"
                        MoveItemDown="MoveInstructionDown_Click" />
                    <Button Content="âž• Insert"
                            Click="AddNewInstruction_Click"
                            Tag="{Binding}"
                            ToolTip.Tip="Insert new instruction here"
                            Padding="8,4" />
                </StackPanel>
            </Grid>

            <!-- Action Type Selector -->
            <StackPanel Spacing="4">
                <TextBlock Text="Action Type" Classes="summary-label" />
                <TextBlock Classes="secondary-text" FontSize="11">
                    <Run Text="Choose what operation this instruction performs" />
                </TextBlock>
                <ComboBox ItemsSource="{Binding ActionTypes}"
                          SelectedItem="{Binding ActionString, Converter={StaticResource ActionConverter}}"
                          Focusable="True"
                          HorizontalAlignment="Stretch" />
            </StackPanel>

            <!-- Source Field (for Choose action: show Component selector) -->
            <StackPanel Spacing="4" IsVisible="{Binding Action, Converter={StaticResource ChooseActionVisibility}}">
                <TextBlock Text="Components/Options to Choose From" Classes="summary-label" />
                <TextBlock Classes="secondary-text" FontSize="11" TextWrapping="Wrap">
                    <Run Text="Select which components or options the user can choose from at install time" />
                </TextBlock>
                <controls:DependencyControl>
                    <controls:DependencyControl.ThisGuidList>
                        <Binding Path="Source" Converter="{StaticResource GuidListConverter}" />
                    </controls:DependencyControl.ThisGuidList>
                </controls:DependencyControl>
            </StackPanel>

            <!-- Source Field (for all other actions: show file paths) -->
            <StackPanel Spacing="4" IsVisible="{Binding Action, Converter={StaticResource NotChooseActionVisibility}}">
                <TextBlock Text="Source File(s)" Classes="summary-label" />
                <TextBlock Classes="secondary-text" FontSize="11" TextWrapping="Wrap">
                    <Run Text="File paths or wildcards (e.g., &lt;&lt;modDirectory&gt;&gt;\*.zip)" />
                </TextBlock>
                <Grid ColumnDefinitions="*,Auto">
                    <TextBox Grid.Column="0" AcceptsReturn="True" TextWrapping="Wrap"
                             Focusable="True" MinHeight="60"
                             x:Name="SourceTextBox"
                             Text="{Binding Source, Converter={StaticResource ListToStringConverter}}"
                             Watermark="Enter file paths (one per line)..." />
                    <StackPanel Grid.Column="1" Spacing="4" Margin="4,0,0,0">
                        <controls:BrowseButtonsControl
                            BrowseSourceFiles="BrowseSourceFiles_Click"
                            BrowseSourceFromFolders="BrowseSourceFromFolders_Click" />
                    </StackPanel>
                </Grid>
                <!-- Path Status & Resolved Preview -->
                <Border Classes="summary-card" Padding="8,6" Margin="0,4,0,0">
                    <StackPanel Spacing="4">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="{Binding Source, Converter={StaticResource PathStatusConverter}}"
                                       Classes="secondary-text" FontSize="11" />
                        </StackPanel>
                        <TextBlock Text="{Binding Source, Converter={StaticResource PathResolverConverter}}"
                                   Classes="secondary-text" FontSize="10" FontStyle="Italic"
                                   TextWrapping="Wrap" MaxLines="3" />
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Destination Field (Move, Copy, Rename, Patcher) -->
            <StackPanel Spacing="4" IsVisible="{Binding Action, Converter={StaticResource NotChooseActionVisibility}}">
                <TextBlock Text="Destination" Classes="summary-label" />
                <TextBlock Classes="secondary-text" FontSize="11" TextWrapping="Wrap">
                    <Run Text="Target directory or new filename for Rename" />
                </TextBlock>
                <Grid ColumnDefinitions="*,Auto">
                    <TextBox Grid.Column="0" Focusable="True" TextWrapping="Wrap"
                             x:Name="DestinationTextBox" Text="{Binding Destination}"
                             Watermark="e.g., &lt;&lt;kotorDirectory&gt;&gt;\Override" />
                    <Button Grid.Column="1" Content="ðŸ“ Browse"
                            Click="BrowseDestination_Click"
                            Tag="{Binding ElementName=DestinationTextBox}"
                            Margin="4,0,0,0" />
                </Grid>
                <!-- Path Status & Resolved Preview -->
                <Border Classes="summary-card" Padding="8,6" Margin="0,4,0,0">
                    <StackPanel Spacing="4">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="{Binding Destination, Converter={StaticResource PathStatusConverter}}"
                                       Classes="secondary-text" FontSize="11" />
                        </StackPanel>
                        <TextBlock Text="{Binding Destination, Converter={StaticResource PathResolverConverter}}"
                                   Classes="secondary-text" FontSize="10" FontStyle="Italic"
                                   TextWrapping="Wrap" MaxLines="3" />
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Arguments Field - Show ComboBox for Patcher with namespaces.ini -->
            <StackPanel Spacing="4" IsVisible="{Binding Action, Converter={StaticResource PatcherActionVisibility}}">
                <TextBlock Text="Patcher Options" Classes="summary-label" />
                <TextBlock Classes="secondary-text" FontSize="11" TextWrapping="Wrap">
                    <Run Text="Select install option from namespaces.ini (if available)" />
                </TextBlock>
                <ComboBox Focusable="True"
                          HorizontalAlignment="Stretch"
                          ItemsSource="{Binding ., Converter={StaticResource NamespacesIniOptionConverter}}"
                          SelectedIndex="{Binding Arguments}"
                          ToolTip.Tip="Select namespace option" />
            </StackPanel>

            <!-- Arguments Field - TextBox for Execute, DelDuplicate, Run (not for Patcher or Choose) -->
            <StackPanel Spacing="4">
                <StackPanel.IsVisible>
                    <MultiBinding Converter="{StaticResource NotPatcherActionVisibility}">
                        <Binding Path="Action" />
                    </MultiBinding>
                </StackPanel.IsVisible>
                <TextBlock Text="Arguments / Options" Classes="summary-label" />
                <TextBlock Classes="secondary-text" FontSize="11" TextWrapping="Wrap">
                    <Run Text="â€¢ Execute: Command-line arguments" />
                    <LineBreak />
                    <Run Text="â€¢ DelDuplicate: File extension (e.g., .mdl)" />
                    <LineBreak />
                    <Run Text="â€¢ Patcher: Use options above" />
                </TextBlock>
                <TextBox Focusable="True" Text="{Binding Arguments}"
                         Watermark="Enter arguments if needed..." />
            </StackPanel>

            <!-- Overwrite Checkbox (Move, Copy, Rename, Extract) -->
            <StackPanel Spacing="4" IsVisible="{Binding Action, Converter={StaticResource NotChooseActionVisibility}}">
                <CheckBox Focusable="True"
                          IsChecked="{Binding Overwrite}"
                          Content="Overwrite existing files"
                          ToolTip.Tip="If checked, existing files will be replaced" />
            </StackPanel>

            <Separator Classes="summary-separator" />

            <!-- Conditional Execution Settings -->
            <Expander Header="âš™ï¸ Conditional Execution (Optional)" IsExpanded="False">
                <StackPanel Spacing="12" Margin="0,8,0,0">
                    <StackPanel Spacing="4">
                        <TextBlock Text="Dependencies" Classes="summary-label"
                                   ToolTip.Tip="This instruction will NOT run if ANY of these are NOT selected" />
                        <TextBlock Classes="secondary-text" FontSize="11" TextWrapping="Wrap">
                            <Run Text="Instruction only runs if all these mods/options are selected" />
                        </TextBlock>
                        <controls:DependencyControl ThisGuidList="{Binding Dependencies}" />
                    </StackPanel>

                    <StackPanel Spacing="4">
                        <TextBlock Text="Restrictions" Classes="summary-label"
                                   ToolTip.Tip="This instruction will NOT run if ANY of these are selected" />
                        <TextBlock Classes="secondary-text" FontSize="11" TextWrapping="Wrap">
                            <Run Text="Instruction is skipped if any of these mods/options are selected" />
                        </TextBlock>
                        <controls:DependencyControl ThisGuidList="{Binding Restrictions}" />
                    </StackPanel>
                </StackPanel>
            </Expander>
        </StackPanel>
    </Border>
</UserControl>

<!--  Copyright 2021-2025 KOTORModSync  -->
<!--  Licensed under the Business Source License 1.1 (BSL 1.1).  -->
<!--  See LICENSE.txt file in the project root for full license information.  -->
<UserControl
    x:Class="KOTORModSync.Controls.InstructionEditorControl"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:KOTORModSync.Controls"
    xmlns:converters="clr-namespace:KOTORModSync.Converters">
    <UserControl.Resources>
        <converters:IndexConverter x:Key="IndexConverter" />
        <converters:ActionConverter x:Key="ActionConverter" />
        <converters:ListToStringConverter x:Key="ListToStringConverter" />
        <converters:ChooseInstructionDisplayConverter x:Key="ChooseInstructionDisplayConverter" />
        <converters:ComponentsListConverter x:Key="ComponentsListConverter" />
        <converters:ChooseActionVisibility x:Key="ChooseActionVisibility" />
        <converters:NotDestinationActionVisibility x:Key="NotDestinationActionVisibility" />
        <converters:PatcherActionVisibility x:Key="PatcherActionVisibility" />
        <converters:NotPatcherActionVisibility x:Key="NotPatcherActionVisibility" />
        <converters:ArgumentsVisibilityConverter x:Key="ArgumentsVisibilityConverter" />
        <converters:PatcherWithNamespacesVisibilityConverter x:Key="PatcherWithNamespacesVisibilityConverter" />
        <converters:ExecuteDelDuplicateVisibilityConverter x:Key="ExecuteDelDuplicateVisibilityConverter" />
        <converters:SourceFilesVisibilityConverter x:Key="SourceFilesVisibilityConverter" />
        <converters:ArgumentsTextConverter x:Key="ArgumentsTextConverter" />
        <converters:ArgumentsDescriptionConverter x:Key="ArgumentsDescriptionConverter" />
        <converters:ExecuteActionVisibilityConverter x:Key="ExecuteActionVisibilityConverter" />
        <converters:GuidListConverter x:Key="GuidListConverter" />
        <converters:NamespacesIniOptionConverter x:Key="NamespacesIniOptionConverter" />
        <converters:PathStatusConverter x:Key="PathStatusConverter" />
        <converters:PathResolverConverter x:Key="PathResolverConverter" />
        <converters:PathStatusDetailedConverter x:Key="PathStatusDetailedConverter" />
        <converters:ValidationStatusMessageConverter x:Key="ValidationStatusMessageConverter" />
        <converters:ValidationDetailedMessageConverter x:Key="ValidationDetailedMessageConverter" />
        <converters:ValidationHasBlockingInstructionConverter x:Key="ValidationHasBlockingInstructionConverter" />
        <converters:ValidationBlockingInstructionTextConverter x:Key="ValidationBlockingInstructionTextConverter" />
    </UserControl.Resources>

    <Border
        Margin="0,2,0,0"
        Padding="3"
        Classes="summary-instruction-card">
        <Expander HorizontalAlignment="Stretch" IsExpanded="False">
            <Expander.Header>
                <Grid HorizontalAlignment="Stretch" ColumnDefinitions="Auto,*,Auto">
                    <Border
                        Grid.Column="0"
                        Margin="0,0,6,0"
                        Padding="4,2"
                        Classes="mod-list-item-badge"
                        CornerRadius="4">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontSize="10"
                            FontWeight="Bold">
                            <TextBlock.Text>
                                <MultiBinding Converter="{StaticResource IndexConverter}">
                                    <MultiBinding.Bindings>
                                        <Binding Path="$parent[ItemsRepeater].Instructions" />
                                        <Binding Path="." />
                                    </MultiBinding.Bindings>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </Border>

                    <StackPanel
                        Grid.Column="1"
                        VerticalAlignment="Center"
                        Orientation="Horizontal"
                        Spacing="6">
                        <TextBlock FontWeight="SemiBold" Text="{Binding Action}" />
                        <TextBlock Opacity="0.5" Text="â†’" />
                        <TextBlock
                            MaxWidth="300"
                            DataContext="{Binding .}"
                            Opacity="0.7"
                            TextTrimming="CharacterEllipsis">
                            <TextBlock.Text>
                                <MultiBinding Converter="{StaticResource ChooseInstructionDisplayConverter}">
                                    <Binding Path="." />
                                    <Binding Converter="{StaticResource ComponentsListConverter}" Path="$parent[UserControl].DataContext" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>

                    <StackPanel
                        Grid.Column="2"
                        Orientation="Horizontal"
                        Spacing="2">
                        <controls:ActionButtonsControl
                            DeleteItem="DeleteInstruction_Click"
                            MoveItemDown="MoveInstructionDown_Click"
                            MoveItemUp="MoveInstructionUp_Click" />
                        <Button
                            Click="AddNewInstruction_Click"
                            Content="âž• Insert"
                            Tag="{Binding}"
                            ToolTip.Tip="Insert new instruction here" />
                    </StackPanel>
                </Grid>
            </Expander.Header>

            <StackPanel Margin="0,4,0,0" Spacing="3">
                <!--  Action Type Selector  -->
                <StackPanel Spacing="1">
                    <TextBlock Classes="summary-label" Text="Action Type" />
                    <TextBlock Classes="secondary-text" FontSize="9">
                        <Run Text="Choose what operation this instruction performs" />
                    </TextBlock>
                    <ComboBox
                        HorizontalAlignment="Stretch"
                        Focusable="True"
                        ItemsSource="{Binding ActionTypes}"
                        SelectedItem="{Binding ActionString, Converter={StaticResource ActionConverter}}" />
                </StackPanel>

                <!--  Source Field (for Choose action: show ModComponent selector)  -->
                <StackPanel IsVisible="{Binding Action, Converter={StaticResource ChooseActionVisibility}}" Spacing="1">
                    <TextBlock Classes="summary-label" Text="Components/Options to Choose From" />
                    <TextBlock
                        Classes="secondary-text"
                        FontSize="9"
                        TextWrapping="Wrap">
                        <Run Text="Select which components or options the user can choose from at install time" />
                    </TextBlock>
                    <controls:DependencyControl HorizontalAlignment="Stretch">
                        <controls:DependencyControl.ThisGuidList>
                            <x:Null />
                        </controls:DependencyControl.ThisGuidList>
                    </controls:DependencyControl>
                </StackPanel>

                <!--  Source Field (for all other actions: show file paths)  -->
                <StackPanel IsVisible="{Binding Action, Converter={StaticResource SourceFilesVisibilityConverter}}" Spacing="1">
                    <TextBlock Classes="summary-label" Text="Source File(s)" />
                    <TextBlock
                        Classes="secondary-text"
                        FontSize="9"
                        TextWrapping="Wrap">
                        <Run Text="File paths or wildcards (e.g., &lt;&lt;modDirectory&gt;&gt;\*.zip)" />
                    </TextBlock>
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBox
                            x:Name="SourceTextBox"
                            Grid.Column="0"
                            MinHeight="30"
                            AcceptsReturn="True"
                            Focusable="True"
                            Text="{Binding Source, Converter={StaticResource ListToStringConverter}}"
                            TextWrapping="Wrap"
                            Watermark="Enter file paths (one per line)..." />
                        <StackPanel
                            Grid.Column="1"
                            Margin="2,0,0,0"
                            Spacing="2">
                            <controls:BrowseButtonsControl BrowseSourceFiles="BrowseSourceFiles_Click" BrowseSourceFromFolders="BrowseSourceFromFolders_Click" />
                        </StackPanel>
                    </Grid>
                    <!--  Path Status & Resolved Preview  -->
                    <Border
                        Margin="0,2,0,0"
                        Padding="4,3"
                        Classes="summary-card">
                        <StackPanel Spacing="2">
                            <Grid ColumnDefinitions="*,Auto">
                                <StackPanel
                                    Grid.Column="0"
                                    Orientation="Horizontal"
                                    Spacing="4">
                                    <TextBlock
                                        Classes="secondary-text"
                                        FontSize="9"
                                        Text="{Binding Source, Converter={StaticResource PathStatusDetailedConverter}, ConverterParameter={Binding .}, Converter={StaticResource ValidationStatusMessageConverter}}"
                                        ToolTip.Tip="{Binding Source, Converter={StaticResource PathStatusDetailedConverter}, ConverterParameter={Binding .}, Converter={StaticResource ValidationDetailedMessageConverter}}" />
                                </StackPanel>
                                <Button
                                    Grid.Column="1"
                                    Padding="4,2"
                                    Click="JumpToBlockingInstruction_Click"
                                    Content="{Binding Source, Converter={StaticResource PathStatusDetailedConverter}, ConverterParameter={Binding .}, Converter={StaticResource ValidationBlockingInstructionTextConverter}}"
                                    FontSize="8"
                                    IsVisible="{Binding Source, Converter={StaticResource PathStatusDetailedConverter}, ConverterParameter={Binding .}, Converter={StaticResource ValidationHasBlockingInstructionConverter}}"
                                    Tag="{Binding Source, Converter={StaticResource PathStatusDetailedConverter}, ConverterParameter={Binding .}}"
                                    ToolTip.Tip="Click to jump to the instruction that's preventing this path from being valid" />
                            </Grid>
                            <TextBlock
                                Classes="secondary-text"
                                FontSize="8"
                                FontStyle="Italic"
                                MaxLines="2"
                                Text="{Binding Source, Converter={StaticResource PathResolverConverter}}"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!--  Destination Field (Move, Copy, Rename, Patcher)  -->
                <StackPanel IsVisible="{Binding Action, Converter={StaticResource NotDestinationActionVisibility}}" Spacing="1">
                    <TextBlock Classes="summary-label" Text="Destination" />
                    <TextBlock
                        Classes="secondary-text"
                        FontSize="9"
                        TextWrapping="Wrap">
                        <Run Text="Target directory or new filename for Rename" />
                    </TextBlock>
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBox
                            x:Name="DestinationTextBox"
                            Grid.Column="0"
                            Focusable="True"
                            Text="{Binding Destination}"
                            TextWrapping="Wrap"
                            Watermark="e.g., &lt;&lt;kotorDirectory&gt;&gt;\Override" />
                        <Button
                            Grid.Column="1"
                            Margin="2,0,0,0"
                            Click="BrowseDestination_Click"
                            Content="ðŸ“ Browse"
                            Tag="{Binding ElementName=DestinationTextBox}" />
                    </Grid>
                    <!--  Path Status & Resolved Preview  -->
                    <Border
                        Margin="0,1,0,0"
                        Padding="3,2"
                        Classes="summary-card">
                        <StackPanel Spacing="1">
                            <Grid ColumnDefinitions="*,Auto">
                                <StackPanel
                                    Grid.Column="0"
                                    Orientation="Horizontal"
                                    Spacing="3">
                                    <TextBlock
                                        Classes="secondary-text"
                                        FontSize="8"
                                        Text="{Binding Destination, Converter={StaticResource PathStatusDetailedConverter}, ConverterParameter={Binding .}, Converter={StaticResource ValidationStatusMessageConverter}}"
                                        ToolTip.Tip="{Binding Destination, Converter={StaticResource PathStatusDetailedConverter}, ConverterParameter={Binding .}, Converter={StaticResource ValidationDetailedMessageConverter}}" />
                                </StackPanel>
                                <Button
                                    Grid.Column="1"
                                    Padding="3,1"
                                    Click="JumpToBlockingInstruction_Click"
                                    Content="{Binding Destination, Converter={StaticResource PathStatusDetailedConverter}, ConverterParameter={Binding .}, Converter={StaticResource ValidationBlockingInstructionTextConverter}}"
                                    FontSize="7"
                                    IsVisible="{Binding Destination, Converter={StaticResource PathStatusDetailedConverter}, ConverterParameter={Binding .}, Converter={StaticResource ValidationHasBlockingInstructionConverter}}"
                                    Tag="{Binding Destination, Converter={StaticResource PathStatusDetailedConverter}, ConverterParameter={Binding .}}"
                                    ToolTip.Tip="Click to jump to the instruction that's preventing this path from being valid" />
                            </Grid>
                            <TextBlock
                                Classes="secondary-text"
                                FontSize="8"
                                FontStyle="Italic"
                                MaxLines="2"
                                Text="{Binding Destination, Converter={StaticResource PathResolverConverter}}"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!--  Arguments Field - Show only for DelDuplicate, Execute, and Patcher actions  -->
                <StackPanel IsVisible="{Binding Action, Converter={StaticResource ArgumentsVisibilityConverter}}" Spacing="1">
                    <TextBlock Classes="summary-label" Text="{Binding Action, Converter={StaticResource ArgumentsTextConverter}}" />
                    <TextBlock
                        Classes="secondary-text"
                        FontSize="9"
                        Text="{Binding Action, Converter={StaticResource ArgumentsDescriptionConverter}}"
                        TextWrapping="Wrap" />

                    <!--  ComboBox for Patcher with namespaces.ini  -->
                    <ComboBox
                        HorizontalAlignment="Stretch"
                        Focusable="True"
                        IsVisible="{Binding ., Converter={StaticResource PatcherWithNamespacesVisibilityConverter}}"
                        ItemsSource="{Binding ., Converter={StaticResource NamespacesIniOptionConverter}}"
                        SelectedIndex="{Binding Arguments}"
                        ToolTip.Tip="Select namespace option" />

                    <!--  File Extensions Control for DelDuplicate actions  -->
                    <controls:FileExtensionsControl x:Name="FileExtensionsControl" IsVisible="{Binding Action, Converter={StaticResource ExecuteDelDuplicateVisibilityConverter}}" />

                    <!--  TextBox for Execute actions only  -->
                    <TextBox
                        Focusable="True"
                        IsVisible="{Binding Action, Converter={StaticResource ExecuteActionVisibilityConverter}}"
                        Text="{Binding Arguments}"
                        Watermark="Enter command line arguments..." />
                </StackPanel>

                <!--  Overwrite Checkbox (Move, Copy, Rename, Extract)  -->
                <StackPanel IsVisible="{Binding Action, Converter={StaticResource NotDestinationActionVisibility}}" Spacing="1">
                    <CheckBox
                        Content="Overwrite existing files"
                        Focusable="True"
                        IsChecked="{Binding Overwrite}"
                        ToolTip.Tip="If checked, existing files will be replaced" />
                </StackPanel>

                <Separator Classes="summary-separator" />

                <!--  Conditional Execution Settings  -->
                <Expander Header="âš™ï¸ Conditional Execution âš™ï¸" IsExpanded="False">
                    <Border Margin="0,2,0,0" Padding="2">
                        <Grid ColumnDefinitions="*,*">
                            <StackPanel
                                Grid.Column="0"
                                Margin="0,0,2,2"
                                Spacing="1">
                                <TextBlock
                                    Classes="summary-label"
                                    Text="Dependencies"
                                    ToolTip.Tip="This instruction will NOT run if ANY of these are NOT selected" />
                                <TextBlock
                                    Classes="secondary-text"
                                    FontSize="8"
                                    TextWrapping="Wrap">
                                    <Run Text="Instruction only runs if all these mods/options are selected" />
                                </TextBlock>
                                <controls:DependencyControl HorizontalAlignment="Stretch" ThisGuidList="{Binding Dependencies}" />
                            </StackPanel>

                            <StackPanel
                                Grid.Column="1"
                                Margin="2,0,0,2"
                                Spacing="1">
                                <TextBlock
                                    Classes="summary-label"
                                    Text="Restrictions"
                                    ToolTip.Tip="This instruction will NOT run if ANY of these are selected" />
                                <TextBlock
                                    Classes="secondary-text"
                                    FontSize="8"
                                    TextWrapping="Wrap">
                                    <Run Text="Instruction is skipped if any of these mods/options are selected" />
                                </TextBlock>
                                <controls:DependencyControl HorizontalAlignment="Stretch" ThisGuidList="{Binding Restrictions}" />
                            </StackPanel>
                        </Grid>
                    </Border>
                </Expander>
            </StackPanel>
        </Expander>
    </Border>
</UserControl>

<!--  Copyright 2021-2025 KOTORModSync  -->
<!--  Licensed under the Business Source License 1.1 (BSL 1.1).  -->
<!--  See LICENSE.txt file in the project root for full license information.  -->
<Window
    x:Class="KOTORModSync.Dialogs.SettingsDialog"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:KOTORModSync.Controls"
    xmlns:converters="clr-namespace:KOTORModSync.Converters"
    Title="Settings"
    Width="500"
    Height="600"
    MinWidth="400"
    MinHeight="400"
    ExtendClientAreaChromeHints="NoChrome"
    ExtendClientAreaTitleBarHeightHint="-1"
    ExtendClientAreaToDecorationsHint="True"
    SystemDecorations="BorderOnly"
    WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <converters:IsUnixConverter x:Key="IsUnixConverter" />
    </Window.Resources>

    <Window.Styles>
        <StyleInclude Source="/Styles/ContentPresenterFix.axaml" />
    </Window.Styles>

    <Grid Margin="20" RowDefinitions="Auto,*,Auto">
        <!--  Custom Window Controls  -->
        <StackPanel
            Grid.Row="0"
            Grid.RowSpan="3"
            Margin="0,8,8,0"
            HorizontalAlignment="Right"
            VerticalAlignment="Top"
            Orientation="Horizontal"
            Spacing="0">
            <Button
                Width="40"
                Height="40"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                Click="MinimizeButton_Click"
                Content="-"
                FontSize="15" />
            <Button
                Width="40"
                Height="40"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                Click="ToggleMaximizeButton_Click"
                Content="â–¢"
                FontSize="15" />
            <Button
                Width="40"
                Height="40"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                Click="CloseButton_Click"
                Content="X"
                FontSize="15" />
        </StackPanel>

        <!--  Header  -->
        <TextBlock
            Grid.Row="1"
            Margin="0,0,0,20"
            HorizontalAlignment="Center"
            FontSize="24"
            FontWeight="Bold"
            Text="âš™ï¸ Settings" />

        <!--  Settings Content  -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="15">
                <!--  ReSharper disable once Xaml.BindingWithoutContextNotResolved  -->
                <StackPanel x:Name="SettingsStackPanel" DataContext="{Binding MainConfigInstance}">


                    <!--  General Settings Section  -->
                    <Border
                        Padding="15"
                        BorderThickness="2"
                        CornerRadius="8">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="âš™ï¸ General Settings" />

                            <CheckBox
                                Content="Verbose Logging"
                                IsChecked="{Binding debugLogging}"
                                ToolTip.Tip="Shows extra output in both the logfile and the output window." />

                            <CheckBox
                                Margin="0,5,0,0"
                                Content="Auto-Fix Config Errors"
                                IsChecked="{Binding attemptFixes}"
                                ToolTip.Tip="Sometimes config files have simple mistakes, this attempts to use some common sense to fix common errors in a TOML file. This only executes when an error is detected during a validation." />

                            <CheckBox
                                Margin="0,5,0,0"
                                Content="Don't ask for Admin"
                                IsChecked="{Binding noAdmin}"
                                ToolTip.Tip="Activating this toggles __COMPAT_LAYER=RunAsInvoker for 'Patcher' and 'Execute' instructions. It signals Windows to launch executables as if they already have admin rights, preventing unnecessary UAC checks. Handy for older apps without an app.manifest (e.g. TSLPatcher). Note: enabling this setting might cause permission issues. Instead, running ModSync as administrator is recommended. On Linux/Mac this simply calls `sudo -n true` instead of `sudo` when relevant." />

                            <CheckBox
                                Margin="0,5,0,0"
                                Content="Mock case-insensitive filesystem"
                                IsChecked="{Binding caseInsensitivePathing}"
                                ToolTip.Tip="Attempt to perform case-insensitive file/folder lookups for all instructions. Somewhat slow, especially on HDDs.">
                                <CheckBox.IsVisible>
                                    <Binding Converter="{StaticResource IsUnixConverter}" />
                                </CheckBox.IsVisible>
                            </CheckBox>

                            <TextBlock
                                Margin="0,15,0,5"
                                FontWeight="Bold"
                                Text="File Encoding:" />
                            <ComboBox
                                x:Name="FileEncodingComboBox"
                                Margin="0,5,0,0"
                                HorizontalAlignment="Stretch"
                                SelectedIndex="0"
                                SelectionChanged="FileEncodingComboBox_SelectionChanged"
                                ToolTip.Tip="Character encoding used when loading/saving mod files. UTF-8 is standard, but Windows-1252 may be needed for files with special characters.">
                                <ComboBoxItem Content="UTF-8" Tag="utf-8" />
                                <ComboBoxItem Content="Windows-1252 (CP-1252)" Tag="windows-1252" />
                            </ComboBox>
                            <TextBlock
                                Margin="0,5,0,0"
                                FontSize="11"
                                Opacity="0.7"
                                Text="Change this if you're experiencing errors with special characters in TOML/YAML/JSON files."
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!--  Download Settings Section  -->
                    <Border
                        Padding="15"
                        BorderThickness="2"
                        CornerRadius="8">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="ðŸ“¥ Download Settings" />

                            <CheckBox
                                Content="Validate and replace invalid archives"
                                IsChecked="{Binding validateAndReplaceInvalidArchives}"
                                ToolTip.Tip="When enabled, automatically validates downloaded archive files (zip, rar, 7z) using 7-Zip. If an archive is corrupt or incomplete, it will be automatically deleted and re-downloaded. When disabled, existing files are never replaced, which may result in using corrupt archives." />

                            <CheckBox
                                Margin="0,5,0,0"
                                Content="Filter downloads by screen resolution"
                                IsChecked="{Binding filterDownloadsByResolution}"
                                ToolTip.Tip="When enabled, automatically skips downloading files that don't match your system's screen resolution. For example, if you have a 1920x1080 display, files with '3840x2160' in the name will be skipped. This saves bandwidth and disk space by only downloading resolution-specific files that match your display." />

                            <TextBlock
                                Margin="0,15,0,5"
                                FontWeight="Bold"
                                Text="Nexus Mods API Key (Optional):" />
                            <TextBox
                                Text="{Binding nexusModsApiKey}"
                                ToolTip.Tip="Optional: Enter your Nexus Mods API key for handling downloads from NexusMods. Get your API key from: https://www.nexusmods.com/users/myaccount?tab=api+access."
                                Watermark="Enter your Nexus Mods API key here..." />
                            <TextBlock
                                Margin="0,5,0,0"
                                FontSize="11"
                                Opacity="0.7"
                                Text="Get your API key from: https://www.nexusmods.com/users/myaccount?tab=api+access"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!--  Directory Settings Section  -->
                    <Border
                        Padding="15"
                        BorderThickness="2"
                        CornerRadius="8">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="ðŸ“ Directory Settings" />

                            <controls:DirectoryPickerControl
                                x:Name="ModDirectoryPicker"
                                Title="Mod Location:"
                                Margin="0,0,0,10"
                                DirectoryChanged="OnDirectoryChanged"
                                PickerType="ModDirectory"
                                Watermark="Enter mod directory path" />

                            <controls:DirectoryPickerControl
                                x:Name="KotorDirectoryPicker"
                                Title="Kotor Directory:"
                                DirectoryChanged="OnDirectoryChanged"
                                PickerType="KotorDirectory"
                                Watermark="Enter KOTOR installation directory" />
                        </StackPanel>
                    </Border>

                    <!--  PyKotor/HoloPatcher Settings Section  -->
                    <Border
                        Padding="15"
                        BorderThickness="2"
                        CornerRadius="8">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="ðŸ”§ PyKotor/HoloPatcher Version" />

                            <TextBlock
                                Margin="0,0,0,10"
                                Opacity="0.8"
                                Text="Select and download different versions of the PyKotor library (which includes HoloPatcher). The bundled version is included with the application, but you can update to newer releases from GitHub."
                                TextWrapping="Wrap" />

                            <ComboBox
                                x:Name="HolopatcherVersionComboBox"
                                Margin="0,5,0,0"
                                HorizontalAlignment="Stretch"
                                ToolTip.Tip="Select a PyKotor version to download and install (includes HoloPatcher source)"
                                Watermark="Fetching available PyKotor versions..." />

                            <StackPanel
                                Margin="0,10,0,0"
                                Orientation="Horizontal"
                                Spacing="10">
                                <Button
                                    x:Name="RefreshVersionsButton"
                                    Click="RefreshVersionsButton_Click"
                                    Content="Refresh Versions"
                                    ToolTip.Tip="Fetch the latest available HoloPatcher versions from GitHub" />
                                <Button
                                    x:Name="DownloadVersionButton"
                                    Click="DownloadVersionButton_Click"
                                    Content="Download Selected"
                                    ToolTip.Tip="Download and install the selected HoloPatcher version" />
                            </StackPanel>

                            <TextBlock
                                x:Name="CurrentVersionLabel"
                                Margin="0,10,0,0"
                                FontSize="11"
                                Opacity="0.7"
                                Text="Current: Using bundled PyKotor source"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!--  About & Updates Section  -->
                    <Border
                        Padding="15"
                        BorderThickness="2"
                        CornerRadius="8">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="â„¹ï¸ About &amp; Updates" />

                            <TextBlock
                                Margin="0,0,0,10"
                                Text="Keep KOTORModSync up to date with the latest features and improvements."
                                TextWrapping="Wrap" />

                            <Button
                                x:Name="CheckForUpdatesButton"
                                Margin="0,5,0,0"
                                HorizontalAlignment="Left"
                                Click="CheckForUpdates_Click"
                                Content="Check for Updates"
                                ToolTip.Tip="Manually check for available updates" />

                            <TextBlock
                                x:Name="UpdateStatusText"
                                Margin="0,10,0,0"
                                FontSize="12"
                                Opacity="0.7"
                                Text="Application will check for updates automatically."
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!--  Telemetry Settings Section  -->
                    <Border
                        Padding="15"
                        BorderThickness="2"
                        CornerRadius="8">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="ðŸ“Š Telemetry &amp; Analytics" />

                            <TextBlock
                                Margin="0,0,0,10"
                                Opacity="0.8"
                                Text="Anonymous telemetry helps improve KOTORModSync by collecting usage statistics, performance metrics, and crash reports. All data is fully anonymized and sent securely to bolabaden.org. You can opt-out at any time."
                                TextWrapping="Wrap" />

                            <CheckBox
                                x:Name="EnableTelemetryCheckBox"
                                Margin="0,5,0,0"
                                Content="Enable anonymous telemetry"
                                IsChecked="True"
                                ToolTip.Tip="Enable or disable all telemetry collection. When enabled, anonymous usage data, performance metrics, and crash reports help improve the application. All data is cryptographically hashed and fully anonymized." />

                            <Separator Margin="0,10" />

                            <TextBlock
                                FontSize="11"
                                Opacity="0.7"
                                Text="What we collect: Feature usage, performance timings, crash reports (hashed)."
                                TextWrapping="Wrap" />

                            <TextBlock
                                Margin="0,5,0,0"
                                FontSize="11"
                                Opacity="0.7"
                                Text="What we DON'T collect: Personal information, mod names, file paths, passwords, or any sensitive data. All data is cryptographically anonymized."
                                TextWrapping="Wrap" />

                            <Button
                                Margin="0,10,0,0"
                                HorizontalAlignment="Left"
                                Click="ViewPrivacyDetails_Click"
                                Content="View Privacy Details"
                                ToolTip.Tip="See exactly what data is collected and how it's used" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>

        <!--  Buttons  -->
        <StackPanel
            Grid.Row="3"
            Margin="0,20,0,0"
            HorizontalAlignment="Right"
            Orientation="Horizontal">
            <Button
                MinWidth="80"
                Margin="0,0,10,0"
                Click="Cancel_Click"
                Content="Cancel" />
            <Button
                MinWidth="80"
                Click="OK_Click"
                Content="OK" />
        </StackPanel>
    </Grid>
</Window>

<!-- Copyright 2021-2025 KOTORModSync -->
<!-- Licensed under the Business Source License 1.1 (BSL 1.1). -->
<!-- See LICENSE.txt file in the project root for full license information. -->
<Window
    x:Class="KOTORModSync.Dialogs.SettingsDialog"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:KOTORModSync.Controls"
    xmlns:converters="clr-namespace:KOTORModSync.Converters"
    Title="Settings"
    Width="500"
    Height="600"
    MinWidth="400"
    MinHeight="400"
    ExtendClientAreaChromeHints="NoChrome"
    ExtendClientAreaTitleBarHeightHint="-1"
    ExtendClientAreaToDecorationsHint="True"
    SystemDecorations="BorderOnly"
    WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <converters:IsUnixConverter x:Key="IsUnixConverter" />
    </Window.Resources>

    <Window.Styles>
        <StyleInclude Source="/Styles/ContentPresenterFix.axaml" />
        <StyleInclude Source="/Styles/KotorStyle.axaml" />
    </Window.Styles>

    <Grid Margin="20" RowDefinitions="Auto,*,Auto">
        <!--  Custom Window Controls  -->
        <StackPanel
            Grid.Row="0"
            Grid.RowSpan="3"
            Margin="0,8,8,0"
            HorizontalAlignment="Right"
            VerticalAlignment="Top"
            Orientation="Horizontal"
            Spacing="0">
            <Button
                Width="40"
                Height="40"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                Click="MinimizeButton_Click"
                Content="-"
                FontSize="15" />
            <Button
                Width="40"
                Height="40"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                Click="ToggleMaximizeButton_Click"
                Content="â–¢"
                FontSize="15" />
            <Button
                Width="40"
                Height="40"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                Click="CloseButton_Click"
                Content="X"
                FontSize="15" />
        </StackPanel>

        <!--  Header  -->
        <TextBlock
            Grid.Row="0"
            Margin="0,0,0,20"
            HorizontalAlignment="Center"
            FontSize="24"
            FontWeight="Bold"
            Text="âš™ï¸ Settings" />

        <!--  Settings Content  -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="15">
                <!--  ReSharper disable once Xaml.BindingWithoutContextNotResolved  -->
                <StackPanel x:Name="SettingsStackPanel" DataContext="{Binding MainConfigInstance}">

                    <!--  Theme Section  -->
                    <Border
                        Padding="15"
                        BorderThickness="2"
                        CornerRadius="8">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="ðŸŽ¨ Theme Settings" />
                            <TextBlock FontWeight="Bold" Text="Theme:" />
                            <ComboBox
                                x:Name="StyleComboBox"
                                Margin="0,5,0,0"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                SelectedIndex="0"
                                SelectionChanged="StyleComboBox_SelectionChanged">
                                <ComboBoxItem Content="K1 Style" Tag="/Styles/KotorStyle.axaml" />
                                <ComboBoxItem Content="TSL Style" Tag="/Styles/Kotor2Style.axaml" />
                            </ComboBox>
                        </StackPanel>
                    </Border>

                    <!--  General Settings Section  -->
                    <Border
                        Padding="15"
                        BorderThickness="2"
                        CornerRadius="8">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="âš™ï¸ General Settings" />

                            <CheckBox
                                Content="Verbose Logging"
                                IsChecked="{Binding debugLogging}"
                                ToolTip.Tip="Shows extra output in both the logfile and the output window." />

                            <CheckBox
                                Margin="0,5,0,0"
                                Content="Auto-Fix Config Errors"
                                IsChecked="{Binding attemptFixes}"
                                ToolTip.Tip="Sometimes config files have simple mistakes, this attempts to use some common sense to fix common errors in a TOML file. This only executes when an error is detected during a validation." />

                            <CheckBox
                                Margin="0,5,0,0"
                                Content="Don't ask for Admin"
                                IsChecked="{Binding noAdmin}"
                                ToolTip.Tip="Activating this toggles __COMPAT_LAYER=RunAsInvoker for 'Patcher' and 'Execute' instructions. It signals Windows to launch executables as if they already have admin rights, preventing unnecessary UAC checks. Handy for older apps without an app.manifest (e.g. TSLPatcher). Note: enabling this setting might cause permission issues. Instead, running ModSync as administrator is recommended. On Linux/Mac this simply calls `sudo -n true` instead of `sudo` when relevant." />

                            <CheckBox
                                Margin="0,5,0,0"
                                Content="Mock case-insensitive filesystem"
                                IsChecked="{Binding caseInsensitivePathing}"
                                ToolTip.Tip="Attempt to perform case-insensitive file/folder lookups for all instructions. Somewhat slow, especially on HDDs.">
                                <CheckBox.IsVisible>
                                    <Binding Converter="{StaticResource IsUnixConverter}" />
                                </CheckBox.IsVisible>
                            </CheckBox>
                        </StackPanel>
                    </Border>

                    <!--  Download Settings Section  -->
                    <Border
                        Padding="15"
                        BorderThickness="2"
                        CornerRadius="8">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="ðŸ“¥ Download Settings" />

                            <CheckBox
                                Content="Validate and replace invalid archives"
                                IsChecked="{Binding validateAndReplaceInvalidArchives}"
                                ToolTip.Tip="When enabled, automatically validates downloaded archive files (zip, rar, 7z) using 7-Zip. If an archive is corrupt or incomplete, it will be automatically deleted and re-downloaded. When disabled, existing files are never replaced, which may result in using corrupt archives." />

                            <TextBlock
                                Margin="0,15,0,5"
                                FontWeight="Bold"
                                Text="Nexus Mods API Key (Optional):" />
                            <TextBox
                                Text="{Binding nexusModsApiKey}"
                                ToolTip.Tip="Optional: Enter your Nexus Mods API key for handling downloads from NexusMods. Get your API key from: https://www.nexusmods.com/users/myaccount?tab=api+access."
                                Watermark="Enter your Nexus Mods API key here..." />
                            <TextBlock
                                Margin="0,5,0,0"
                                FontSize="11"
                                Opacity="0.7"
                                Text="Get your API key from: https://www.nexusmods.com/users/myaccount?tab=api+access"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!--  Directory Settings Section  -->
                    <Border
                        Padding="15"
                        BorderThickness="2"
                        CornerRadius="8">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="ðŸ“ Directory Settings" />

                            <controls:DirectoryPickerControl
                                x:Name="ModDirectoryPicker"
                                Title="Mod Location:"
                                Margin="0,0,0,10"
                                DirectoryChanged="OnDirectoryChanged"
                                PickerType="ModDirectory"
                                Watermark="Enter mod directory path" />

                            <controls:DirectoryPickerControl
                                x:Name="KotorDirectoryPicker"
                                Title="Kotor Directory:"
                                DirectoryChanged="OnDirectoryChanged"
                                PickerType="KotorDirectory"
                                Watermark="Enter KOTOR installation directory" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>

        <!--  Buttons  -->
        <StackPanel
            Grid.Row="2"
            Margin="0,20,0,0"
            HorizontalAlignment="Right"
            Orientation="Horizontal">
            <Button
                MinWidth="80"
                Margin="0,0,10,0"
                Click="Cancel_Click"
                Content="Cancel" />
            <Button
                MinWidth="80"
                Click="OK_Click"
                Content="OK" />
        </StackPanel>
    </Grid>
</Window>

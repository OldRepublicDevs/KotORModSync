<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:core="clr-namespace:KOTORModSync.Core;assembly=KOTORModSync.Core"
        xmlns:controls="clr-namespace:KOTORModSync.Controls"
        xmlns:converters="clr-namespace:KOTORModSync.Converters"
        x:Class="KOTORModSync.MainWindow"
        Title="KOTORModSync"
        Width="1280" Height="720" MinWidth="600" MinHeight="400"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        ExtendClientAreaTitleBarHeightHint="-1"
        SystemDecorations="BorderOnly"
        DragDrop.AllowDrop="True">

    <Window.Resources>
        <converters:ListToStringConverter x:Key="ListToStringConverter" />
        <converters:IndexConverter x:Key="IndexConverter" />
        <converters:ActionConverter x:Key="ActionConverter" />
        <converters:NamespacesIniOptionConverter x:Key="NamespacesIniOptionConverter" />
        <converters:ListToVisibilityConverter x:Key="ListToVisibilityConverter" />
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter" />
        <converters:ChooseActionVisibility x:Key="ChooseActionVisibility" />
        <converters:NotChooseActionVisibility x:Key="NotChooseActionVisibility" />
        <converters:GuidToComponentConverter x:Key="GuidToComponentConverter" />
        <converters:GuidListConverter x:Key="GuidListConverter" />
        <converters:IsWindowsConverter x:Key="IsWindowsConverter" />
        <converters:IsUnixConverter x:Key="IsUnixConverter" />
        <converters:DownloadStatusConverter x:Key="DownloadStatusConverter" />
        <converters:DownloadTooltipConverter x:Key="DownloadTooltipConverter" />
        <converters:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
    </Window.Resources>

    <Window.Styles>
        <StyleInclude Source="/Styles/KotorStyle.axaml" />
        <StyleInclude Source="/Styles/ContentPresenterFix.axaml" />
    </Window.Styles>
    <!--<Window.Styles>
        <Style DataType="control:LogViewerControlViewModel">
            <Setter Property="Template">
                <ControlTemplate>
                    <controls:LogViewerControl />
                </ControlTemplate>
            </Setter>
        </Style>
    </Window.Styles>-->

    <Panel>

    <Grid x:Name="MainGrid" MinWidth="200" RowDefinitions="Auto,Auto,*">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="250" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- Header row: menu (left), centered title (middle), window controls (right) -->
        <Grid Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <Menu x:Name="TopMenu" Grid.Column="0" />
            <TextBlock x:Name="TitleTextBlock" Grid.Column="1" Text="KOTORModSync" FontSize="24"
                       FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center" />
            <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Spacing="0">
                <Button Content="-" Click="MinimizeButton_Click" HorizontalContentAlignment="Center"
                        VerticalAlignment="Stretch" HorizontalAlignment="Stretch" Width="40" Height="40" FontSize="15" />
                <Button Content="â–¢" Click="ToggleMaximizeButton_Click"
                        HorizontalContentAlignment="Center" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" Width="40" Height="40" FontSize="15" />
                <Button Content="X" Click="CloseButton_Click"
                        HorizontalContentAlignment="Center" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" Width="40" Height="40" FontSize="15" />
            </StackPanel>
        </Grid>
        <!-- Getting Started button row -->
        <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,4,10,4">
                <ToggleSwitch x:Name="EditorModeToggle" Content="Editor Mode"
                              IsChecked="{Binding EditorMode, Mode=TwoWay}"
                              VerticalAlignment="Center" Margin="0,0,20,0"
                              ToolTip.Tip="Toggle to enable Editor Mode: exposes Raw/GUI edit tabs, editing buttons, and creation tools. When off, the UI is simplified for end users installing mods." />
                <Button x:Name="HomeButton" Content="ðŸ  Getting Started"
                        Click="HomeButton_Click"
                        ToolTip.Tip="Return to the getting started guide" />
                <Button x:Name="OutputWindowButton" Content="ðŸ“Š Output Window"
                        Click="OpenOutputWindow_Click"
                        ToolTip.Tip="Open the output window to view detailed logs"
                        Margin="10,0,0,0" />
                <Button x:Name="HeaderSettingsButton" Content="âš™ï¸ Settings"
                        Click="OpenSettings_Click"
                        ToolTip.Tip="Open settings dialog to configure preferences"
                        Margin="10,0,0,0" />
            </StackPanel>
        </Grid>

        <Grid Grid.Row="2" Grid.Column="0" RowDefinitions="Auto,Auto,*" Margin="0,0,10,0">
            <!-- Search Box -->
            <!-- ReSharper disable once Xaml.BindingWithoutContextNotResolved -->
            <controls:SearchBox Grid.Row="0" Margin="0,0,0,2" HorizontalAlignment="Stretch"
                               Name="SearchBox"
                               SearchText="{Binding SearchText, Mode=TwoWay}"
                               Watermark="Search mods by name or author..."/>

            <!-- Select All/Deselect All Header -->
            <Border Grid.Row="1"
                    Background="#031332"
                    BorderBrush="#062766"
                    BorderThickness="0,0,0,1"
                    Padding="8,4"
                    Margin="0,0,0,2">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <CheckBox Grid.Column="0"
                              x:Name="SelectAllCheckBox"
                              IsChecked="{Binding RootSelectionState, Mode=TwoWay}"
                              IsThreeState="True"
                              VerticalAlignment="Center"
                              Margin="0,0,8,0" />
                    <TextBlock Grid.Column="1"
                               Text="Available Mods"
                               FontWeight="Bold"
                               FontSize="13"
                               VerticalAlignment="Center" />
                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                        <TextBlock x:Name="ModCountText"
                                   Text="0 mods"
                                   FontSize="11"
                                   VerticalAlignment="Center"
                                   Foreground="#888888" />
                        <TextBlock Text="â€¢"
                                   FontSize="11"
                                   VerticalAlignment="Center"
                                   Foreground="#888888" />
                        <TextBlock x:Name="SelectedCountText"
                                   Text="0 selected"
                                   FontSize="11"
                                   VerticalAlignment="Center"
                                   Foreground="#888888" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Mod List -->
            <ScrollViewer Grid.Row="2" HorizontalScrollBarVisibility="Disabled">
                <ListBox x:Name="ModListBoxElement"
                         Background="Transparent"
                         BorderThickness="0"
                         SelectionMode="Single"
                         Padding="0">
                    <ListBox.Styles>
                        <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                            <Setter Property="Background" Value="#1A3AAAFF" />
                        </Style>
                        <Style Selector="ListBoxItem:selected">
                            <Setter Property="Background" Value="#1A3AAAFF" />
                        </Style>
                        <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="#0A3AAAFF" />
                        </Style>
                    </ListBox.Styles>
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="core:Component">
                            <controls:ModListItem DataContext="{Binding}" />
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </ScrollViewer>
        </Grid>
        <GridSplitter Grid.Column="0" Grid.Row="2" Width="5" HorizontalAlignment="Right" />
        <TabControl Grid.Row="2" Grid.Column="1" x:Name="TabControl"
            SelectionChanged="TabControl_SelectionChanged"
            HorizontalAlignment="Stretch">
            <TabItem x:Name="InitialTab" Header="Getting Started" IsVisible="False">
                <TabItem.Content>
                    <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="20" Spacing="20">
                            <TextBlock Text="Welcome to KOTORModSync!" Classes="welcome-title" />

                            <TextBlock Text="Follow these steps to install your KOTOR mods:" FontSize="16"
                                     HorizontalAlignment="Center" Margin="0,0,0,10" />

                            <!-- Step 1: Directories -->
                            <Border x:Name="Step1Border" Classes="step-border">
                                <StackPanel>
                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        <TextBlock Grid.Column="0" Text="1ï¸âƒ£" Classes="step-number" />
                                        <TextBlock Grid.Column="1" Text="Set Directories" Classes="step-title" />
                                        <Border Grid.Column="2" x:Name="Step1CompleteIndicator" Classes="step-pending">
                                            <TextBlock x:Name="Step1CompleteText" Text="Pending" Classes="step-pending-text" />
                                        </Border>
                                    </Grid>
                                    <TextBlock Text="Configure your mod directory and KOTOR installation directory"
                                             Margin="30,10,0,10" TextWrapping="Wrap" />

                                    <!-- Directory Controls -->
                                    <StackPanel Margin="30,10,0,10">
                                        <controls:DirectoryPickerControl x:Name="Step1ModDirectoryPicker"
                                                                       Title="Mod Location:"
                                                                       Watermark="Enter mod directory path"
                                                                       PickerType="ModDirectory"
                                                                       DirectoryChanged="OnDirectoryChanged"
                                                                       Margin="0,0,0,10" />

                                        <controls:DirectoryPickerControl x:Name="Step1KotorDirectoryPicker"
                                                                       Title="Kotor Directory:"
                                                                       Watermark="Enter KOTOR installation directory"
                                                                       PickerType="KotorDirectory"
                                                                       DirectoryChanged="OnDirectoryChanged" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Step 2: Load Instructions -->
                            <Border x:Name="Step2Border" Classes="step-border">
                                <StackPanel>
                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        <TextBlock Grid.Column="0" Text="2ï¸âƒ£" Classes="step-number" />
                                        <TextBlock Grid.Column="1" Text="Load Instruction File" Classes="step-title" />
                                        <Border Grid.Column="2" x:Name="Step2CompleteIndicator" Classes="step-pending">
                                            <TextBlock x:Name="Step2CompleteText" Text="Pending" Classes="step-pending-text" />
                                        </Border>
                                    </Grid>
                                    <TextBlock Text="Load a mod configuration file or create a new one"
                                             Margin="30,10,0,10" TextWrapping="Wrap" />
                                    <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                        <Button x:Name="Step2Button" Content="ðŸ“„ Load Instruction File"
                                              Click="Step2Button_Click" HorizontalAlignment="Left"
                                              ToolTip.Tip="Click 'Load Installation File' in the top menu"
                                              Margin="0,0,10,0" />
                                        <Button x:Name="GettingStartedSettingsButton" Content="âš™ï¸ Settings"
                                              Click="OpenSettings_Click" HorizontalAlignment="Left"
                                              ToolTip.Tip="Open settings dialog to configure preferences" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Step 3: Select Mods -->
                            <Border x:Name="Step3Border" Classes="step-border">
                                <StackPanel>
                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        <TextBlock Grid.Column="0" Text="3ï¸âƒ£" Classes="step-number" />
                                        <TextBlock Grid.Column="1" Text="Select Mods &amp; Options" Classes="step-title" />
                                        <Border Grid.Column="2" x:Name="Step3CompleteIndicator" Classes="step-pending">
                                            <TextBlock x:Name="Step3CompleteText" Text="Pending" Classes="step-pending-text" />
                                        </Border>
                                    </Grid>
                                    <TextBlock Text="Choose which mods to install from the list on the left, and configure any options"
                                             Margin="30,10,0,10" TextWrapping="Wrap" />
                                    <TextBlock Text="ðŸ‘ˆ Use the left panel to select mods and customize their options"
                                             Margin="30,5,0,10" FontStyle="Italic" />
                                </StackPanel>
                            </Border>

                            <Border x:Name="Step4Border" Classes="step-border">
                                <StackPanel>
                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        <TextBlock Grid.Column="0" Text="4ï¸âƒ£" Classes="step-number" />
                                        <TextBlock Grid.Column="1" Text="Download Mods" Classes="step-title" />
                                        <Border Grid.Column="2" x:Name="Step4CompleteIndicator" Classes="step-pending">
                                            <TextBlock x:Name="Step4CompleteText" Text="Pending" Classes="step-pending-text" />
                                        </Border>
                                    </Grid>
                                    <TextBlock Text="Make sure each selected mod is downloaded into your Mod Directory before installing."
                                             Margin="30,10,0,10" TextWrapping="Wrap" />
                                    <TextBlock Text="The downloader will attempt to fetch files automatically, but you may need to grab some manually."
                                             Margin="30,0,0,10" TextWrapping="Wrap" />
                                    <StackPanel Orientation="Horizontal" Margin="30,5,0,0" Spacing="10">
                                        <Button x:Name="ScrapeDownloadsButton" Content="Fetch Downloads" Click="ScrapeDownloadsButton_Click"
                                                ToolTip.Tip="Try to download all missing mod archives automatically" />
                                        <Button x:Name="OpenModDirectoryButton" Content="Open Mod Directory" Click="OpenModDirectoryButton_Click"
                                                ToolTip.Tip="Open your configured Mod Directory in the file explorer" />
                                    </StackPanel>
                                    <TextBlock x:Name="DownloadStatusText" Margin="30,10,0,0" TextWrapping="Wrap"
                                               Foreground="Gray"
                                               Text="Status: Waiting for download scan..." />
                                </StackPanel>
                            </Border>

                            <!-- Step 4: Install -->
                            <Border x:Name="Step5Border" Classes="step-border">
                                <StackPanel>
                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        <TextBlock Grid.Column="0" Text="5ï¸âƒ£" Classes="step-number" />
                                        <TextBlock Grid.Column="1" Text="Validate &amp; Install" Classes="step-title" />
                                        <Border Grid.Column="2" x:Name="Step5CompleteIndicator" Classes="step-pending">
                                            <TextBlock x:Name="Step5CompleteText" Text="Pending" Classes="step-pending-text" />
                                        </Border>
                                    </Grid>
                                    <TextBlock Text="Validate your configuration and start the installation process"
                                             Margin="30,10,0,10" TextWrapping="Wrap" />
                                    <StackPanel Orientation="Horizontal" Margin="30,5,0,0">
                                        <Button x:Name="ValidateButton" Content="ðŸ” Validate"
                                              Click="GettingStartedValidateButton_Click" Margin="0,0,10,0"
                                              ToolTip.Tip="Check for any issues before installation" />
                                        <Button x:Name="InstallButton" Content="âš¡ Start Install"
                                              Click="InstallButton_Click"
                                              ToolTip.Tip="Begin the mod installation process" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Progress Section -->
                            <Border Classes="progress-section">
                                <StackPanel>
                                    <TextBlock Text="ðŸ“Š Progress Overview" FontSize="16" FontWeight="Bold"
                                             HorizontalAlignment="Center" Margin="0,0,0,10" />
                                    <ProgressBar x:Name="OverallProgressBar" Height="20" Minimum="0" Maximum="5" Value="0"/>
                                    <TextBlock x:Name="ProgressText" Text="Complete the steps above to get started"
                                             HorizontalAlignment="Center" Margin="0,5,0,0" FontStyle="Italic" />
                                </StackPanel>
                            </Border>

                            <!-- Additional Help -->
                            <Border Classes="help-section">
                                <StackPanel>
                                    <TextBlock Text="ðŸ’¡ Need Help?" FontSize="16" FontWeight="Bold"
                                             HorizontalAlignment="Center" Margin="0,0,0,10" />
                                    <TextBlock TextWrapping="Wrap" HorizontalAlignment="Center">
                                        <Run Text="â€¢ Check the "/>
                                        <Run Text="Output Window" FontWeight="Bold" />
                                        <Run Text=" for detailed logs and error messages"/>
                                        <LineBreak/>
                                        <Run Text="â€¢ Use the "/>
                                        <Run Text="Validate" FontWeight="Bold" />
                                        <Run Text=" button to check for issues before installing"/>
                                        <LineBreak/>
                                        <Run Text="â€¢ Enable "/>
                                        <Run Text="Verbose Logging" FontWeight="Bold" />
                                        <Run Text=" in Settings for more details"/>
                                    </TextBlock>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">
                                        <Button x:Name="GettingStartedOpenOutputButton" Content="ðŸ“Š Open Output Window"
                                              Click="OpenOutputWindow_Click" Margin="0,0,10,0"
                                              ToolTip.Tip="Open the output window to view detailed logs" />
                                        <Button x:Name="GettingStartedHelpSettingsButton" Content="âš™ï¸ Settings"
                                              Click="OpenSettings_Click"
                                              ToolTip.Tip="Open settings dialog to configure preferences" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem.Content>
            </TabItem>
            <TabItem x:Name="SummaryTabItem" Header="Summary" IsVisible="False">
                <TabItem.Content>
                    <ScrollViewer HorizontalScrollBarVisibility="Disabled"
                        VerticalScrollBarVisibility="Auto">
                        <!-- ReSharper disable once Xaml.BindingWithoutContextNotResolved -->
                        <StackPanel DataContext="{Binding CurrentComponent}">
                            <TextBlock Text="Download Links:" FontWeight="DemiBold"
                                Margin="0, 0, 0, 0"
                                ToolTip.Tip="Click a link to open it in your browser."
                                IsVisible="{Binding ModLink, Converter={StaticResource ListToVisibilityConverter}}" />
                            <ItemsRepeater ItemsSource="{Binding ModLink}"
                                IsVisible="{Binding ModLink, Converter={StaticResource ListToVisibilityConverter}}">
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel>
                                            <SelectableTextBlock Text="{Binding }"
                                                TextDecorations="Underline"
                                                Tapped="OpenLink_Click"
                                                Margin="10,0,0,0" TextWrapping="Wrap"
                                                FontSize="17"
                                                Cursor="Hand">
                                                <TextBlock.ContextMenu>
                                                    <ContextMenu>
                                                        <MenuItem Header="Copy"
                                                            Click="CopyTextToClipboard_Click" />
                                                    </ContextMenu>
                                                </TextBlock.ContextMenu>
                                            </SelectableTextBlock>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>
                            <TextBlock Margin="0,10,0,0" Text="Name:" FontWeight="Bold"
                                IsVisible="{Binding Name, Converter={StaticResource StringToVisibilityConverter}}" />
                            <TextBlock Text="{Binding Name}" Margin="10,0,0,0"
                                IsVisible="{Binding Name, Converter={StaticResource StringToVisibilityConverter}}" />

                            <TextBlock Text="Author(s):" FontWeight="Bold" Margin="0,10,0,0"
                                IsVisible="{Binding Author, Converter={StaticResource StringToVisibilityConverter}}" />
                            <TextBlock Text="{Binding Author}" Margin="10,0,0,0"
                                IsVisible="{Binding Author, Converter={StaticResource StringToVisibilityConverter}}" />

                            <TextBlock Text="Category:" FontWeight="Bold" Margin="0,10,0,0"
                                IsVisible="{Binding Category, Converter={StaticResource StringToVisibilityConverter}}" />
                            <TextBlock Text="{Binding Category}" Margin="10,0,0,0"
                                IsVisible="{Binding Category, Converter={StaticResource StringToVisibilityConverter}}" />

                            <TextBlock Text="Tier:" FontWeight="Bold" Margin="0,10,0,0"
                                IsVisible="{Binding Tier, Converter={StaticResource StringToVisibilityConverter}}" />
                            <TextBlock Text="{Binding Tier}" Margin="10,0,0,0"
                                IsVisible="{Binding Tier, Converter={StaticResource StringToVisibilityConverter}}" />

                            <TextBlock Text="Description:" FontWeight="Bold" Margin="0,10,0,0"
                                IsVisible="{Binding Description, Converter={StaticResource StringToVisibilityConverter}}" />
                            <TextBlock Text="{Binding Description}" Margin="10,0,0,0"
                                TextWrapping="Wrap"
                                IsVisible="{Binding Description, Converter={StaticResource StringToVisibilityConverter}}" />

                            <TextBlock Text="Directions:" FontWeight="Bold" Margin="0,10,0,0"
                                IsVisible="{Binding Directions, Converter={StaticResource StringToVisibilityConverter}}" />
                            <TextBlock Text="{Binding Directions}" Margin="10,0,0,0"
                                TextWrapping="Wrap"
                                IsVisible="{Binding Directions, Converter={StaticResource StringToVisibilityConverter}}" />

                            <TextBlock Text="Select your Options/Customizations here"
                                FontWeight="Bold"
                                FontSize="17"
                                TextAlignment="Center"
                                Margin="0,15,0,0"
                                IsVisible="{Binding ElementName=OptionsSummaryRepeater,
                                        Path=ItemsSource,
                                        Converter={StaticResource ListToVisibilityConverter}}" />
                            <ItemsRepeater
                                x:Name="OptionsSummaryRepeater"
                                ItemsSource="{Binding Options}"
                                Margin="0,0,0,10">
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate DataType="core:Option">
                                        <Border BorderThickness="2"
                                            BorderBrush="LightGray"
                                            Margin="10,10,0,0"
                                            Padding="10">
                                            <StackPanel>
                                                <DockPanel Margin="10,0,0,0">
                                                    <CheckBox Name="OptionIsSelectedCheckBox"
                                                        VerticalContentAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                        IsCheckedChanged="OnCheckBoxChanged"
                                                        Tag="{Binding}"
                                                        Content="{Binding Name}"
                                                        ToolTip.Tip="If checked, this option will be installed." />
                                                </DockPanel>
                                                <TextBlock Text="{Binding Description}"
                                                    TextWrapping="Wrap" />
                                                <ItemsRepeater
                                                    x:Name="optionsInstructionsRepeater"
                                                    ItemsSource="{Binding Instructions}">
                                                    <ItemsRepeater.ItemTemplate>
                                                        <DataTemplate
                                                            DataType="core:Instruction">
                                                            <Grid
                                                                RowDefinitions="Auto,Auto,Auto"
                                                                ColumnDefinitions="Auto,*">
                                                                <DockPanel Grid.Row="0"
                                                                    Grid.RowSpan="2"
                                                                    Grid.Column="1">
                                                                    <TextBlock IsVisible="False">
                                                                        <TextBlock.Text>
                                                                            <MultiBinding
                                                                                Converter="{StaticResource IndexConverter}">
                                                                                <MultiBinding.Bindings>
                                                                                    <!--
                                                                                    ReSharper
                                                                                    disable once
                                                                                    Xaml.PossibleNullReferenceException
                                                                                    Xaml.BindingWithContextNotResolved -->
                                                                                    <Binding
                                                                                        Path="$parent[ItemsRepeater].ItemsSource" />
                                                                                    <Binding
                                                                                        Path="." />
                                                                                </MultiBinding.Bindings>
                                                                            </MultiBinding>
                                                                        </TextBlock.Text>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Text="{Binding Action}"
                                                                        Margin="10,0,0,0"
                                                                        TextWrapping="Wrap" />
                                                                    <TextBlock
                                                                        Text="{Binding Source, Converter={StaticResource ListToStringConverter}}"
                                                                        Margin="10,0,0,0"
                                                                        TextWrapping="Wrap" />
                                                                    <TextBlock
                                                                        Text="{Binding Arguments}"
                                                                        Margin="10,0,0,0"
                                                                        TextWrapping="Wrap" />
                                                                </DockPanel>
                                                            </Grid>
                                                        </DataTemplate>
                                                    </ItemsRepeater.ItemTemplate>
                                                </ItemsRepeater>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>
                            <TextBlock Text="Instructions Overview:"
                                FontWeight="Bold"
                                Margin="0,10"
                                IsVisible="{Binding ElementName=InstructionsSummaryRepeater,
                                        Path=ItemsSource,
                                        Converter={StaticResource ListToVisibilityConverter}}" />
                            <ItemsRepeater
                                x:Name="InstructionsSummaryRepeater"
                                ItemsSource="{Binding Instructions}">
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate
                                        DataType="core:Instruction">
                                        <Border BorderThickness="1" Margin="2,0,0,0">
                                            <Grid
                                                RowDefinitions="Auto,Auto"
                                                ColumnDefinitions="Auto,*">
                                                <TextBlock
                                                    Grid.Column="0"
                                                    Grid.Row="0"
                                                    FontWeight="Bold"
                                                    Margin="2,0,0,0">
                                                    <TextBlock.Text>
                                                        <MultiBinding
                                                            Converter="{StaticResource IndexConverter}">
                                                            <MultiBinding.Bindings>
                                                                <!-- ReSharper disable once Xaml.PossibleNullReferenceException -->
                                                                <Binding Path="$parent[ItemsRepeater].ItemsSource" />
                                                                <Binding Path="." />
                                                            </MultiBinding.Bindings>
                                                        </MultiBinding>
                                                    </TextBlock.Text>
                                                </TextBlock>
                                                <DockPanel Grid.Row="0" Grid.RowSpan="2"
                                                    Grid.Column="1" Margin="10">
                                                    <TextBlock
                                                        Text="{Binding Action}"
                                                        Margin="10,0,0,0"
                                                        FontWeight="DemiBold"
                                                        TextWrapping="Wrap" />

                                                    <!-- For non-Choose actions, keep existing summary -->
                                                    <StackPanel Orientation="Horizontal" Margin="10,0,0,0"
                                                                IsVisible="{Binding Action, Converter={StaticResource NotChooseActionVisibility}}">
                                                    <TextBlock
                                                        Text="{Binding Source, Converter={StaticResource ListToStringConverter}}"
                                                        TextWrapping="Wrap" />
                                                        <TextBlock Text="  " />
                                                    <TextBlock
                                                        Text="{Binding Arguments}"
                                                        TextWrapping="Wrap" />
                                                    </StackPanel>

                                                    <!-- For Choose actions, show resolved components/options with jump buttons -->
                                                    <ItemsControl Margin="10,0,0,0"
                                                                  IsVisible="{Binding Action, Converter={StaticResource ChooseActionVisibility}}">
                                                        <ItemsControl.Items>
                                                            <!-- Bind to Source GUID list (already strings); convert each to Guid and then to label in code-behind if necessary. We'll display via GuidToComponentConverter. -->
                                                        </ItemsControl.Items>
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <StackPanel Orientation="Horizontal" Spacing="6">
                                                                    <TextBlock
                                                                        Text="{Binding ., Converter={StaticResource GuidToComponentConverter}}"
                                                                        ToolTip.Tip="{Binding .}"
                                                                        TextWrapping="Wrap"/>
                                                                </StackPanel>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                        <ItemsControl.ItemsSource>
                                                            <Binding Path="Source" Converter="{StaticResource GuidListConverter}"/>
                                                        </ItemsControl.ItemsSource>
                                                    </ItemsControl>
                                                </DockPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem.Content>
            </TabItem>

            <TabItem x:Name="GuiEditTabItem" Header="GUI Edit" IsVisible="{Binding EditorMode}">
                <TabItem.Content>
                    <ScrollViewer HorizontalScrollBarVisibility="Disabled"
                        VerticalScrollBarVisibility="Auto">
                        <!-- ReSharper disable once Xaml.BindingWithoutContextNotResolved -->
                        <StackPanel x:Name="GuiEditGrid"
                            DataContext="{Binding CurrentComponent}">
                            <Expander Header="Information" IsExpanded="False">
                                <StackPanel>
                                    <TextBlock Text="Name:" />
                                    <TextBox Text="{Binding Name}"
                                        Focusable="True" HorizontalAlignment="Stretch"
                                        TextWrapping="Wrap" />

                                    <TextBlock Text="Description:" />
                                    <TextBox Margin="5,0"
                                        Focusable="True" HorizontalAlignment="Stretch"
                                        TextWrapping="Wrap"
                                        AcceptsTab="True" AcceptsReturn="True"
                                        Text="{Binding Description}" />

                                    <TextBlock Text="Directions:"
                                        ToolTip.Tip="You do not need to follow these directions, this installer will automatically handle the instructions." />
                                    <TextBox Margin="5,0"
                                        Focusable="True" HorizontalAlignment="Stretch"
                                        TextWrapping="Wrap"
                                        AcceptsTab="True" AcceptsReturn="True"
                                        Text="{Binding Directions}" />

                                    <TextBlock Text="Author:" />
                                    <TextBox
                                        Focusable="True" HorizontalAlignment="Stretch"
                                        AcceptsReturn="True"
                                        Text="{Binding Author}" />

                                    <TextBlock Text="Category:" />
                                    <TextBox
                                        Focusable="True" HorizontalAlignment="Stretch"
                                        AcceptsTab="True"
                                        AcceptsReturn="True"
                                        Text="{Binding Category}" />

                                    <TextBlock Text="Tier:" />
                                    <TextBox
                                        Focusable="True" HorizontalAlignment="Stretch"
                                        Text="{Binding Tier}" />

                                    <TextBlock Text="Mod Website:"
                                        ToolTip.Tip="Download the mod here." />
                                    <TextBox
                                        Focusable="True" HorizontalAlignment="Stretch"
                                        AcceptsReturn="True"
                                        Text="{Binding ModLink, Converter={StaticResource ListToStringConverter}}" />

                                    <TextBlock Text="Dependencies:"
                                        Margin="0, 15, 0, 5"
                                        ToolTip.Tip="This mod will not be installed if any of these dependencies are NOT SELECTED for install." />
                                    <controls:DependencyControl
                                        ThisGuidList="{Binding Dependencies}" />

                                    <TextBlock Text="Restrictions:"
                                        Margin="0, 15, 0, 5"
                                        ToolTip.Tip="This mod will not be installed if any of these restrictions are SELECTED for install." />
                                    <controls:DependencyControl
                                        ThisGuidList="{Binding Restrictions}" />

                                    <TextBlock Text="InstallBefore:"
                                        Margin="0, 15, 0, 5" />
                                    <controls:DependencyControl
                                        ThisGuidList="{Binding InstallBefore}" />

                                    <TextBlock Text="InstallAfter:"
                                        Margin="0, 15, 0, 5" />
                                    <controls:DependencyControl
                                        ThisGuidList="{Binding InstallAfter}" />
                                </StackPanel>
                            </Expander>

                            <Expander Header="Instructions" IsExpanded="False">
                                <StackPanel>
                                    <ItemsRepeater x:Name="InstructionsRepeater"
                                        ItemsSource="{Binding Instructions}">
                                        <ItemsRepeater.ItemTemplate>
                                            <DataTemplate DataType="core:Instruction">
                                                <controls:InstructionEditorControl
                                                    AddNewInstruction="AddNewInstruction_Click"
                                                    DeleteInstruction="DeleteInstruction_Click"
                                                    MoveInstructionUp="MoveInstructionUp_Click"
                                                    MoveInstructionDown="MoveInstructionDown_Click"
                                                    BrowseSourceFiles="BrowseSourceFiles_Click"
                                                    BrowseSourceFromFolders="BrowseSourceFromFolders_Click"
                                                    BrowseDestination="BrowseDestination_Click" />
                                            </DataTemplate>
                                        </ItemsRepeater.ItemTemplate>
                                    </ItemsRepeater>
                                    <Button
                                        Content="Create Instructions"
                                        Click="AddNewInstruction_Click" Tag="{Binding}" />
                                </StackPanel>
                            </Expander>
                            <Expander Header="Options" IsExpanded="False"
                                x:Name="OptionsExpander">
                                <StackPanel>
                                    <ItemsRepeater x:Name="OptionsRepeater"
                                        ItemsSource="{Binding Options}">
                                        <ItemsRepeater.ItemTemplate>
                                            <DataTemplate DataType="core:Option">
                                                <controls:OptionEditorControl
                                                    AddNewOption="AddNewOption_Click"
                                                    DeleteOption="DeleteOption_Click"
                                                    MoveOptionUp="MoveOptionUp_Click"
                                                    MoveOptionDown="MoveOptionDown_Click"
                                                    AddNewInstruction="AddNewInstruction_Click"
                                                    DeleteInstruction="DeleteInstruction_Click"
                                                    MoveInstructionUp="MoveInstructionUp_Click"
                                                    MoveInstructionDown="MoveInstructionDown_Click"
                                                    BrowseSourceFiles="BrowseSourceFiles_Click"
                                                    BrowseSourceFromFolders="BrowseSourceFromFolders_Click"
                                                    BrowseDestination="BrowseDestination_Click" />
                                            </DataTemplate>
                                        </ItemsRepeater.ItemTemplate>
                                    </ItemsRepeater>
                                    <Button Content="Create Options" Click="AddNewOption_Click"
                                            ToolTip.Tip="If this mod has optional components a user can choose, define them here."
                                            Tag="{Binding}" />
                                </StackPanel>
                            </Expander>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem.Content>
            </TabItem>
            <TabItem x:Name="RawEditTabItem" Header="Raw Edit" IsVisible="{Binding EditorMode}"
                     ToolTip.Tip="Click 'Apply Editor Changes' to save raw changes">
                <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                    <StackPanel HorizontalAlignment="Stretch">
                        <DockPanel>
                            <Button HorizontalContentAlignment="Center" HorizontalAlignment="Stretch"
                                    x:Name="ApplyEditorButton" Content="Apply Editor Changes"
                                    Click="SaveButton_Click" />
                            <Button Content="Generate GUID" Click="GenerateGuidButton_Click"
                                    ToolTip.Tip="A GUID is used to ensure uniqueness of items.
							            Do not replace existing guids unless you know what you're doing,
								        else anything that relies on the pre-existing GUIDs will have their references broken." />
                            <TextBox x:Name="GuidGeneratedTextBox" Focusable="True" HorizontalContentAlignment="Left" />
                        </DockPanel>
                        <TextBox x:Name="RawEditTextBox" AcceptsReturn="True" TextWrapping="Wrap" MinHeight="400" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
        <!--<ContentControl
        Grid.Row="4" Content="{Binding LogViewer}" />-->
    </Grid>
    </Panel>
</Window>
<!--  Copyright 2021-2025 KOTORModSync  -->
<!--  Licensed under the Business Source License 1.1 (BSL 1.1).  -->
<!--  See LICENSE.txt file in the project root for full license information.  -->
<Window
    x:Class="KOTORModSync.MainWindow"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:KOTORModSync.Controls"
    xmlns:converters="clr-namespace:KOTORModSync.Converters"
    xmlns:core="clr-namespace:KOTORModSync.Core;assembly=KOTORModSync.Core"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    x:Name="RootWindow"
    Title="KOTORModSync"
    Width="1280"
    Height="800"
    MinWidth="600"
    MinHeight="400"
    d:DesignHeight="800"
    d:DesignWidth="1280"
    DragDrop.AllowDrop="True"
    ExtendClientAreaChromeHints="NoChrome"
    ExtendClientAreaTitleBarHeightHint="-1"
    ExtendClientAreaToDecorationsHint="True"
    SystemDecorations="BorderOnly"
    mc:Ignorable="d">

    <Window.Resources>
        <converters:IndexConverter x:Key="IndexConverter" />
        <converters:ListToVisibilityConverter x:Key="ListToVisibilityConverter" />
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter" />
        <converters:InvalidUrlVisibilityConverter x:Key="InvalidUrlVisibilityConverter" />
        <converters:CategoryListDisplayConverter x:Key="CategoryListDisplayConverter" />
        <converters:ListToStringConverter x:Key="ListToStringConverter" />
        <converters:ChooseActionVisibility x:Key="ChooseActionVisibility" />
        <converters:NotDestinationActionVisibility x:Key="NotDestinationActionVisibility" />
        <converters:GuidToComponentConverter x:Key="GuidToComponentConverter" />
        <converters:GuidListConverter x:Key="GuidListConverter" />
        <converters:CategoryTooltipConverter x:Key="CategoryTooltipConverter" />
        <converters:TierTooltipConverter x:Key="TierTooltipConverter" />
        <converters:PathResolverConverter x:Key="PathResolverConverter" />
        <converters:InstructionDestinationConverter x:Key="InstructionDestinationConverter" />
        <converters:BooleanAndConverter x:Key="BooleanAndConverter" />
        <converters:FirstSourcePathConverter x:Key="FirstSourcePathConverter" />
        <converters:ChooseActionDisplayConverter x:Key="ChooseActionDisplayConverter" />
    </Window.Resources>

    <Window.Styles />

    <Panel>
        <Grid RowDefinitions="Auto,Auto,*">
            <!--  Header row: menu, toggles, title, toggles, theme switcher, window controls  -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Menu
                    x:Name="TopMenu"
                    Grid.Column="0"
                    VerticalAlignment="Center" />

                <!--  Spoiler-Free Toggle (left of title)  -->
                <ToggleSwitch
                    x:Name="SpoilerFreeModeToggle"
                    Grid.Column="1"
                    Margin="10,0,10,0"
                    VerticalAlignment="Center"
                    Content="Spoiler-Free"
                    IsChecked="{Binding SpoilerFreeMode, Mode=TwoWay}"
                    IsVisible="{Binding !EditorMode}"
                    ToolTip.Tip="Hide spoiler content" />

                <!--  Title (center)  -->
                <TextBlock
                    x:Name="TitleTextBlock"
                    Grid.Column="2"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    FontSize="24"
                    FontWeight="Bold"
                    Text="KOTORModSync" />

                <!--  Workflow Toggles (right of title)  -->
                <ToggleSwitch
                    x:Name="EditorModeToggle"
                    Grid.Column="3"
                    Margin="10,0,10,0"
                    VerticalAlignment="Center"
                    Content="Editor Mode"
                    IsChecked="{Binding EditorMode, Mode=TwoWay}"
                    IsVisible="{Binding !WizardMode}"
                    ToolTip.Tip="Enable editor mode to author or edit instruction sets manually" />
                <ToggleSwitch
                    x:Name="WizardModeToggle"
                    Grid.Column="4"
                    Margin="0,0,10,0"
                    VerticalAlignment="Center"
                    Content="Wizard Mode"
                    IsChecked="{Binding WizardMode, Mode=TwoWay}"
                    IsVisible="{Binding ShowWizardToggle}"
                    ToolTip.Tip="Use wizard interface for guided installation" />

                <!--  Theme Switcher (segmented control style)  -->
                <Border
                    Grid.Column="5"
                    Margin="10,0,10,0"
                    VerticalAlignment="Center"
                    CornerRadius="4"
                    IsVisible="{Binding MainContentVisible}">
                    <StackPanel Orientation="Horizontal" Spacing="0">
                        <Button
                            x:Name="LightThemeButton"
                            Height="28"
                            MinWidth="36"
                            Margin="0"
                            Padding="8,4"
                            Click="SwitchToLightTheme_Click"
                            Content="â˜€"
                            CornerRadius="4,0,0,4"
                            FontSize="14"
                            ToolTip.Tip="Light Theme" />
                        <Button
                            x:Name="K1ThemeButton"
                            Height="28"
                            MinWidth="36"
                            Margin="0"
                            Padding="8,4"
                            Click="SwitchToK1Theme_Click"
                            Content="K1"
                            CornerRadius="0"
                            FontSize="11"
                            FontWeight="Bold"
                            ToolTip.Tip="KOTOR 1 Theme" />
                        <Button
                            x:Name="TslThemeButton"
                            Height="28"
                            MinWidth="36"
                            Margin="0"
                            Padding="8,4"
                            Click="SwitchToTslTheme_Click"
                            Content="TSL"
                            CornerRadius="0,4,4,0"
                            FontSize="11"
                            FontWeight="Bold"
                            ToolTip.Tip="KOTOR 2: TSL Theme" />
                    </StackPanel>
                </Border>

                <!--  Window Controls  -->
                <StackPanel
                    Grid.Column="6"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center"
                    Orientation="Horizontal"
                    Spacing="0">
                    <Button
                        Width="40"
                        Height="40"
                        HorizontalContentAlignment="Center"
                        Click="MinimizeButton_Click"
                        Content="-"
                        FontSize="15" />
                    <Button
                        Width="40"
                        Height="40"
                        HorizontalContentAlignment="Center"
                        Click="ToggleMaximizeButton_Click"
                        Content="â–¢"
                        FontSize="15" />
                    <Button
                        Width="40"
                        Height="40"
                        HorizontalContentAlignment="Center"
                        Click="CloseButton_Click"
                        Content="X"
                        FontSize="15" />
                </StackPanel>
            </Grid>

            <!--  Home button row (when not in wizard mode)  -->
            <Grid Grid.Row="1" ColumnDefinitions="*">
                <Button
                    x:Name="HomeButton"
                    Grid.Column="0"
                    MinWidth="300"
                    MaxWidth="500"
                    Margin="10,4,10,4"
                    Padding="24,12"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Click="HomeButton_Click"
                    Content="ðŸ  Home"
                    FontSize="18"
                    IsVisible="{Binding MainContentVisible}"
                    ToolTip.Tip="Return to the getting started guide" />
            </Grid>

            <!--  Content Area: Wizard Mode or Normal Mode  -->
            <!--  Wizard Mode (shown when WizardMode is true and EditorMode is false)  -->
            <!--
                The wizard host control mirrors the `WizardContentVisible` binding so the guided installation flow only occupies the main window while Wizard Mode is active.
                Keeping this element collapsed outside of wizard sessions avoids mixing guided steps with editor widgets, reducing confusion for players following instructions.
                When the wizard is enabled the layout hides every other primary surface, allowing this host to deliver a focused, linear experience until the installation completes or the user exits the mode.
            -->
            <controls:WizardHostControl
                x:Name="WizardHost"
                Grid.Row="2"
                IsVisible="{Binding WizardContentVisible}" />

            <!--  Normal Mode (shown when not in wizard mode)  -->
            <!--
                The main editor grid is bound to `MainContentVisible`, which flips to true whenever the application is in authoring mode or the user leaves the guided wizard.
                By placing the majority of editor widgets inside this container we guarantee they all appear and disappear together, keeping transitions between workflows crisp and predictable.
                The grid houses the mod list, tab control, and related editing instruments, so hiding it while the wizard or landing page is active prevents half-configured panels from confusing newcomers.
            -->
            <Grid
                x:Name="MainGrid"
                Grid.Row="2"
                MinWidth="200"
                IsVisible="{Binding MainContentVisible}"
                RowDefinitions="*">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" MinWidth="250" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!--  Mod List Sidebar  -->
                <controls:ModListSidebar
                    x:Name="ModListSidebar"
                    Grid.Row="0"
                    Grid.Column="0"
                    AddNewModRequested="AddNewMod_Click"
                    ApplyCategorySelectionsRequested="ApplyCategorySelections_Click"
                    AutofetchInstructionsRequested="AutoGenerateAllComponents_Click"
                    ClearCategorySelectionRequested="ClearCategorySelection_Click"
                    CloseTOMLRequested="CloseTOMLFile_Click"
                    DeselectAllRequested="DeselectAll_Click"
                    IsVisible="{Binding MainContentVisible}"
                    LockInstallOrderRequested="AutoGenerateDependencies_Click"
                    ModManagementToolsRequested="ShowModManagementDialog"
                    ModStatisticsRequested="ShowModStatistics_Click"
                    RefreshListRequested="RefreshComponents_Click"
                    RemoveAllDependenciesRequested="RemoveAllDependencies_Click"
                    SaveConfigRequested="SaveModFileAs_Click"
                    SearchText="{Binding SearchText, Mode=TwoWay}"
                    SelectAllRequested="SelectAll_Click"
                    SelectByTierRequested="SelectByTier_Click"
                    ValidateAllModsRequested="ValidateAllMods_Click" />
                <GridSplitter
                    Grid.Row="0"
                    Grid.Column="0"
                    HorizontalAlignment="Right"
                    IsVisible="{Binding MainContentVisible}" />
                <!--
                    The editor `TabControl` inherits `MainContentVisible` so the tabbed authoring views are only interactive when the editor surface is intended to be in focus.
                    Binding at the control level, rather than per-tab, keeps the entire suite of editing contexts hidden during wizard sessions while still allowing individual tabs to tweak their own visibility.
                    This approach also ensures keyboard navigation and focus handling behave correctly because the tab control simply does not participate in the visual tree when other modes are active.
                -->
                <TabControl
                    x:Name="TabControl"
                    Grid.Row="0"
                    Grid.Column="1"
                    HorizontalAlignment="Stretch"
                    IsVisible="{Binding MainContentVisible}"
                    SelectionChanged="TabControl_SelectionChanged">
                    <TabItem
                        x:Name="InitialTab"
                        Header="Getting Started"
                        IsVisible="False">
                        <TabItem.Content>
                            <controls:GettingStartedTab
                                x:Name="GettingStartedTabControl"
                                AutoFixRequested="GettingStartedTab_AutoFixRequested"
                                CreateGithubIssueRequested="GettingStartedTab_CreateGithubIssueRequested"
                                DirectoryChangedRequested="GettingStartedTab_DirectoryChangedRequested"
                                DownloadStatusRequested="GettingStartedTab_DownloadStatusRequested"
                                InstallRequested="GettingStartedTab_InstallRequested"
                                JumpToCurrentStepRequested="GettingStartedTab_JumpToCurrentStepRequested"
                                JumpToModRequested="GettingStartedTab_JumpToModRequested"
                                LoadInstructionFileRequested="GettingStartedTab_LoadInstructionFileRequested"
                                NextErrorRequested="GettingStartedTab_NextErrorRequested"
                                OpenModDirectoryRequested="GettingStartedTab_OpenModDirectoryRequested"
                                OpenOutputWindowRequested="GettingStartedTab_OpenOutputWindowRequested"
                                OpenSettingsRequested="GettingStartedTab_OpenSettingsRequested"
                                OpenSponsorPageRequested="GettingStartedTab_OpenSponsorPageRequested"
                                PrevErrorRequested="GettingStartedTab_PrevErrorRequested"
                                ScrapeDownloadsRequested="GettingStartedTab_ScrapeDownloadsRequested"
                                StopDownloadsRequested="GettingStartedTab_StopDownloadsRequested"
                                ValidateRequested="GettingStartedTab_ValidateRequested" />
                        </TabItem.Content>
                    </TabItem>
                    <TabItem
                        x:Name="SummaryTabItem"
                        Header="Summary"
                        IsVisible="{Binding EditorMode}">
                        <TabItem.Content>
                            <controls:SummaryTab
                                x:Name="SummaryTabControl"
                                CheckBoxChangedRequested="SummaryTab_CheckBoxChangedRequested"
                                CopyTextToClipboardRequested="SummaryTab_CopyTextToClipboardRequested"
                                CurrentComponent="{Binding CurrentComponent}"
                                EditorMode="{Binding EditorMode}"
                                JumpToInstructionRequested="SummaryTab_JumpToInstructionRequested"
                                OpenLinkRequested="SummaryTab_OpenLinkRequested"
                                SpoilerFreeMode="{Binding SpoilerFreeMode}"
                                SummaryOptionPointerPressedRequested="SummaryTab_SummaryOptionPointerPressedRequested" />
                        </TabItem.Content>
                    </TabItem>

                    <TabItem
                        x:Name="GuiEditTabItem"
                        Header="Editor"
                        IsVisible="{Binding EditorMode}">
                        <TabItem.Content>
                            <controls:EditorTab
                                x:Name="EditorTabControl"
                                AddNewInstructionRequested="EditorTab_AddNewInstructionRequested"
                                AddNewOptionRequested="EditorTab_AddNewOptionRequested"
                                AutoGenerateInstructionsRequested="EditorTab_AutoGenerateInstructionsRequested"
                                BrowseDestinationRequested="EditorTab_BrowseDestinationRequested"
                                BrowseModFilesRequested="EditorTab_BrowseModFilesRequested"
                                BrowseSourceFilesRequested="EditorTab_BrowseSourceFilesRequested"
                                CollapseAllSectionsRequested="EditorTab_CollapseAllSectionsRequested"
                                CurrentComponent="{Binding CurrentComponent}"
                                DeleteInstructionRequested="EditorTab_DeleteInstructionRequested"
                                DeleteOptionRequested="EditorTab_DeleteOptionRequested"
                                DownloadCacheService="{Binding DownloadCacheService}"
                                ExpandAllSectionsRequested="EditorTab_ExpandAllSectionsRequested"
                                ModManagementService="{Binding ModManagementService}"
                                MoveInstructionDownRequested="EditorTab_MoveInstructionDownRequested"
                                MoveInstructionUpRequested="EditorTab_MoveInstructionUpRequested"
                                MoveOptionDownRequested="EditorTab_MoveOptionDownRequested"
                                MoveOptionUpRequested="EditorTab_MoveOptionUpRequested"
                                TierOptions="{Binding TierOptions}" />
                        </TabItem.Content>
                    </TabItem>
                    <TabItem
                        x:Name="RawEditTabItem"
                        Header="Raw"
                        IsVisible="{Binding EditorMode}"
                        ToolTip.Tip="Click 'Apply Editor Changes' to save raw changes">
                        <TabItem.Content>
                            <controls:RawTab
                                x:Name="RawTabControl"
                                ApplyEditorChangesRequested="RawTab_ApplyEditorChangesRequested"
                                CurrentComponent="{Binding CurrentComponent}"
                                GenerateGuidRequested="RawTab_GenerateGuidRequested" />
                        </TabItem.Content>
                    </TabItem>
                </TabControl>
                <!--<ContentControl
        Grid.Row="4" Content="{Binding LogViewer}" />-->
            </Grid>

            <!--
                The landing page view remains visible only when `LandingPageVisible` is true, providing new users with onboarding cues whenever no instructions are loaded and neither the wizard nor the editor is in play.
                Hiding this control once content becomes available avoids duplicating prompts about loading files, while revealing it again after closing a session gently guides the user back to the recommended setup steps.
                Because the view refreshes its status indicators whenever the visibility flag flips, these bindings ensure the landing experience always reflects the current configuration without manual intervention.
            -->
            <controls:LandingPageView
                x:Name="LandingPage"
                Grid.Row="2"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                IsVisible="{Binding LandingPageVisible}" />

            <!--  Drag & Drop Overlay  -->
            <Border
                x:Name="DragDropOverlay"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                Background="#E0000000"
                IsVisible="False"
                Opacity="0.9">
                <Grid
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    RowDefinitions="Auto,Auto,Auto,Auto">
                    <Border
                        Grid.Row="0"
                        MinWidth="400"
                        MaxWidth="600"
                        Padding="32,24"
                        Background="#F0F0F0"
                        BorderBrush="#CCCCCC"
                        BorderThickness="2"
                        CornerRadius="12">
                        <StackPanel Spacing="16">
                            <TextBlock
                                x:Name="DragDropTitle"
                                HorizontalAlignment="Center"
                                FontSize="24"
                                FontWeight="Bold"
                                Text="Drop File Here" />
                            <TextBlock
                                x:Name="DragDropFileName"
                                HorizontalAlignment="Center"
                                FontSize="18"
                                Text="No file detected"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                            <TextBlock
                                x:Name="DragDropFileInfo"
                                HorizontalAlignment="Center"
                                FontSize="14"
                                Foreground="#666666"
                                Text="File information will appear here"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                            <Border
                                x:Name="DragDropActionBorder"
                                Margin="0,8,0,0"
                                Padding="16,12"
                                Background="#E8F4FD"
                                BorderBrush="#2196F3"
                                BorderThickness="2"
                                CornerRadius="8">
                                <TextBlock
                                    x:Name="DragDropActionText"
                                    HorizontalAlignment="Center"
                                    FontSize="16"
                                    Text="What will happen when you drop this file?"
                                    TextAlignment="Center"
                                    TextWrapping="Wrap" />
                            </Border>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>

        </Grid>

        <!--  Loading Overlay (covers entire window)  -->
        <Border
            x:Name="LoadingOverlay"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            Background="#E0000000"
            IsVisible="False"
            IsHitTestVisible="False"
            Opacity="0.9">
            <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                <Border
                    MinWidth="300"
                    Padding="48,32"
                    Background="#F0F0F0"
                    BorderBrush="#CCCCCC"
                    BorderThickness="2"
                    CornerRadius="12">
                    <StackPanel HorizontalAlignment="Center" Spacing="24">
                        <ProgressBar
                            x:Name="LoadingSpinner"
                            Width="60"
                            Height="60"
                            HorizontalAlignment="Center"
                            IsIndeterminate="True" />
                        <TextBlock
                            x:Name="LoadingText"
                            HorizontalAlignment="Center"
                            FontSize="18"
                            FontWeight="SemiBold"
                            Text="Loading file..."
                            TextAlignment="Center" />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Panel>
</Window>
